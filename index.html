<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Rock ¬∑ Paper ¬∑ Scissors</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f0eeeb;
  --text: #111;
  --muted: rgba(0,0,0,0.28);
  --border: rgba(0,0,0,0.08);
  --surface: rgba(255,255,255,0.7);
  --btn: #111; --btn-fg: #f0eeeb;
  --win: #1a7a42; --lose: #b52038; --tie: #666;
  --glow-win: rgba(26,120,66,0.7);
  --glow-lose: rgba(181,32,56,0.65);
  --glow-tie: rgba(140,140,140,0.5);
  --tr: 0.34s cubic-bezier(0.4,0,0.2,1);
}
[data-theme=dark] {
  --bg: #0c0c0c;
  --text: #f0eeeb;
  --muted: rgba(240,238,235,0.28);
  --border: rgba(240,238,235,0.08);
  --surface: rgba(24,24,24,0.88);
  --btn: #f0eeeb; --btn-fg: #0c0c0c;
  --win: #50c87c; --lose: #e0506a; --tie: #aaa;
  --glow-win: rgba(80,200,124,0.72);
  --glow-lose: rgba(224,80,106,0.68);
  --glow-tie: rgba(160,160,160,0.5);
}

html { height: 100%; }
body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100dvh;
  height: 100dvh;
  display: flex;
  flex-direction: column;
  align-items: center;
  max-width: 430px;
  margin: 0 auto;
  overflow: hidden;
  position: relative;
  transition: background var(--tr), color var(--tr);
  /* safe areas */
  padding-top: env(safe-area-inset-top, 0);
  padding-bottom: env(safe-area-inset-bottom, 0);
}

/* ‚ïê‚ïê HEADER ‚ïê‚ïê */
.hdr {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px 0;
  flex-shrink: 0;
}
.hdr-title {
  font-size: 0.56rem;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--muted);
  font-weight: 400;
}
.hdr-right { display: flex; align-items: center; gap: 10px; }

.speaker-btn {
  width: 30px; height: 30px;
  background: none; border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  color: var(--muted); transition: color 0.2s; outline: none;
  padding: 0; flex-shrink: 0;
}
.speaker-btn:hover { color: var(--text); }
.speaker-btn svg { width: 17px; height: 17px; }

.toggle {
  width: 36px; height: 20px;
  background: var(--border); border: 1px solid var(--border);
  border-radius: 20px; cursor: pointer; position: relative;
  transition: all var(--tr); outline: none; flex-shrink: 0;
}
.toggle::after {
  content: ''; position: absolute;
  width: 13px; height: 13px; background: var(--text);
  border-radius: 50%; top: 50%; left: 3px;
  transform: translateY(-50%);
  transition: left var(--tr), background var(--tr);
}
[data-theme=dark] .toggle::after { left: calc(100% - 16px); }

/* ‚ïê‚ïê SCORE ‚ïê‚ïê */
.score-wrap {
  display: flex; align-items: center; gap: 8px;
  margin-top: 12px; flex-shrink: 0;
}
.score-pill {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 50px; padding: 6px 16px;
  display: flex; align-items: center; gap: 7px;
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  transition: background var(--tr), border var(--tr);
}
.sl { font-size: 0.55rem; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); }
.sn { font-size: 1rem; font-weight: 600; min-width: 13px; text-align: center; transition: transform 0.2s; }
.sn.bump { animation: scoreBump 0.3s ease; }
.sdot { color: var(--muted); font-size: 0.7rem; }

/* ‚ïê‚ïê BF5 DOTS ‚ïê‚ïê */
.bf5 { display: flex; gap: 7px; margin-top: 8px; flex-shrink: 0; }
.bf5-dot {
  width: 5px; height: 5px; border-radius: 50%;
  border: 1.5px solid var(--muted);
  transition: all 0.3s ease;
}
.bf5-dot.p1 { background: var(--text); border-color: var(--text); transform: scale(1.3); }
.bf5-dot.p2 { background: var(--lose); border-color: var(--lose); transform: scale(1.3); }

/* ‚ïê‚ïê MODE ‚ïê‚ïê */
.mode {
  margin-top: 10px; flex-shrink: 0;
  display: flex; background: var(--surface);
  border: 1px solid var(--border); border-radius: 50px;
  padding: 3px; backdrop-filter: blur(8px);
  transition: background var(--tr), border var(--tr);
}
.mode button {
  background: none; border: none; padding: 6px 16px;
  border-radius: 50px; font-family: 'Outfit', sans-serif;
  font-size: 0.64rem; color: var(--muted); cursor: pointer;
  letter-spacing: 0.3px; transition: all 0.22s;
}
.mode button.active { background: var(--btn); color: var(--btn-fg); }

/* ‚ïê‚ïê STAGE ‚Äî the heart of the layout ‚ïê‚ïê 
   Uses a fixed-height container, objects centered absolutely.
   In battle: player left, opponent right. 
*/
.stage-wrap {
  flex: 0 0 260px;
  width: 100%;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: visible;
}

/* Default idle: three objects side by side */
.stage {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding-bottom: 12px;
  position: relative;
}

/* Each object column */
.obj {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
  position: relative;
  /* Each takes equal 1/3 width */
  flex: 1;
  transition: opacity 0.4s ease, transform 0.45s cubic-bezier(0.34,1.4,0.64,1);
  will-change: transform, opacity;
}

/* Image inside each obj */
.obj img {
  display: block;
  object-fit: contain;
  object-position: bottom center;
  pointer-events: none;
  transition: filter 0.35s ease;
}

/* Natural sizes ‚Äî keep rock tallest, scissors medium, paper widest */
#o-rock    img { height: clamp(140px,32vw,190px); width: auto; max-width: 100px; }
#o-paper   img { height: clamp(110px,25vw,155px); width: auto; max-width: 115px; }
#o-scissors img { height: clamp(148px,34vw,198px); width: auto; max-width: 72px; }

.obj-lbl {
  font-size: 0.5rem; letter-spacing: 2.5px; text-transform: uppercase;
  color: var(--muted); margin-top: 6px; font-weight: 400;
  transition: color 0.3s; white-space: nowrap; flex-shrink: 0;
}

/* Float animation when idle */
@keyframes float {
  0%,100% { transform: translateY(0); }
  50%      { transform: translateY(-10px); }
}
.obj img { animation: float 4s ease-in-out infinite; }
#o-rock    img { animation-delay: 0s; }
#o-paper   img { animation-delay: 1.1s; }
#o-scissors img { animation-delay: 2.2s; }
.obj.no-anim img { animation: none; }

/* Hover on idle objs */
.obj.idle:hover { transform: translateY(-9px); }
.obj.idle:active { transform: scale(0.92); transition-duration: 0.08s; }

/* ‚îÄ‚îÄ SELECTED STATE (before play) ‚îÄ‚îÄ */
.obj.selected {
  transform: translateY(-12px) scale(1.04);
  cursor: default;
}
.obj.selected img {
  animation: selectedPulse 2s ease-in-out infinite;
  filter: none !important;
}
.obj.selected .obj-lbl { color: var(--text); }

/* ‚îÄ‚îÄ DIMMED (others when one selected) ‚îÄ‚îÄ */
.obj.dimmed {
  opacity: 0;
  transform: scale(0.7) translateY(20px);
  pointer-events: none;
}

/* ‚ïê‚ïê BATTLE STAGE ‚ïê‚ïê
   After shoot: player obj on LEFT, opp obj on RIGHT.
   We do this by switching to an absolutely positioned layout.
*/
.stage.battle {
  justify-content: space-between;
  padding: 0 16px 12px;
}

.stage.battle .obj.player-obj {
  flex: 1;
  align-items: center;
  cursor: default;
  transform: none !important;
}

.stage.battle .obj.opp-obj {
  flex: 1;
  align-items: center;
  cursor: default;
}

/* Winner: clean lift + brightness boost ‚Äî no colored glow */
.obj.winner img {
  animation: winLift 1.8s ease-in-out infinite !important;
}
.obj.winner.opp-obj img {
  animation: winLift 1.8s ease-in-out infinite !important;
}

/* Loser fade */
.obj.loser {
  opacity: 0.12;
}
.obj.loser img { animation: none !important; filter: none !important; }

/* ‚ïê‚ïê COUNTDOWN ‚ïê‚ïê */
.countdown {
  position: absolute;
  bottom: 50px;
  left: 50%; transform: translateX(-50%);
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  z-index: 30;
  pointer-events: none;
}
.countdown.show { display: flex; }
.cd-dots { display: flex; gap: 9px; }
.cd-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--text); opacity: 0.18;
  transform: scale(1); transition: opacity 0.22s, transform 0.22s;
}
.cd-dot.active { opacity: 1; transform: scale(1.5); }
.cd-shoot {
  font-size: 0.78rem; font-weight: 600;
  letter-spacing: 5px; text-transform: uppercase;
  color: var(--text); opacity: 0;
  transform: scale(0.8);
  transition: opacity 0.2s, transform 0.2s;
}
.cd-shoot.show { opacity: 1; transform: scale(1); }

/* ‚ïê‚ïê RESULT ‚ïê‚ïê */
.result-area {
  width: 100%;
  display: flex; flex-direction: column;
  align-items: center; gap: 3px;
  padding: 6px 20px 0;
  flex-shrink: 0;
  min-height: 36px;
}
.rpill {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 50px; padding: 8px 20px;
  font-size: 0.88rem; font-weight: 600;
  backdrop-filter: blur(12px);
  opacity: 0; transform: translateY(8px) scale(0.96);
  transition: opacity 0.26s, transform 0.26s;
}
.rpill.show { opacity: 1; transform: translateY(0) scale(1); }
.rpill.win  { color: var(--win); }
.rpill.lose { color: var(--lose); }
.rpill.tie  { color: var(--tie); }
.rsub { display: none; }

/* ‚ïê‚ïê P2 ROW ‚ïê‚ïê */
.p2-row {
  display: none; flex-direction: column;
  align-items: center; gap: 6px;
  padding: 8px 20px 0; flex-shrink: 0;
}
.p2-row.on { display: flex; }
.p2-lbl { font-size: 0.5rem; letter-spacing: 2.5px; text-transform: uppercase; color: var(--muted); }
.p2-btns { display: flex; gap: 6px; }
.p2-btn {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 50px; padding: 7px 14px;
  font-family: 'Outfit', sans-serif; font-size: 0.64rem;
  color: var(--muted); cursor: pointer; transition: all 0.18s;
  backdrop-filter: blur(6px);
}
.p2-btn:hover, .p2-btn.on { color: var(--text); border-color: var(--text); }
.p2-btn:disabled { opacity: 0.22; pointer-events: none; }

/* ‚ïê‚ïê PLAY BUTTON ‚Äî centered, full width, no reset ‚ïê‚ïê */
.play-row {
  padding: 10px 20px 0;
  width: 100%; display: flex;
  justify-content: center;
  flex-shrink: 0;
}
.pbtn {
  background: var(--btn); color: var(--btn-fg); border: none;
  border-radius: 50px; padding: 13px 0; width: 100%; max-width: 260px;
  font-family: 'Outfit', sans-serif; font-size: 0.76rem; font-weight: 500;
  letter-spacing: 2.5px; text-transform: uppercase; cursor: pointer;
  transition: all 0.2s, background var(--tr), color var(--tr);
  text-align: center;
}
.pbtn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(0,0,0,0.18); }
.pbtn:active { transform: scale(0.96); }
.pbtn:disabled { opacity: 0.2; transform: none !important; box-shadow: none; cursor: not-allowed; }

/* ‚ïê‚ïê HISTORY ‚ïê‚ïê */
.history { width: 100%; padding: 10px 20px 0; display: flex; flex-direction: column; flex-shrink: 0; min-height: 0; }
.hlbl { font-size: 0.48rem; letter-spacing: 3px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; flex-shrink: 0; }
.hlist-scroll {
  overflow-y: auto;
  max-height: 201px;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.hlist-scroll::-webkit-scrollbar { display: none; }
.hlist { display: flex; flex-direction: column; gap: 4px; }
.hitem {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 9px; padding: 7px 12px;
  display: flex; align-items: center; justify-content: space-between;
  backdrop-filter: blur(6px); animation: fadeUp 0.2s ease both;
  transition: background var(--tr), border var(--tr);
  flex-shrink: 0;
}
.hmoves { font-size: 0.64rem; color: var(--muted); display: flex; align-items: center; gap: 5px; }
.hdot { width: 2px; height: 2px; background: var(--muted); border-radius: 50%; }
.hres { font-size: 0.57rem; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; }
.hres.win{color:var(--win);} .hres.lose{color:var(--lose);} .hres.tie{color:var(--tie);}

/* ‚ïê‚ïê WIN OVERLAY ‚ïê‚ïê */
.win-overlay {
  position: fixed; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 100; opacity: 0; pointer-events: none;
  transition: opacity 0.4s;
  background: rgba(0,0,0,0.2);
  backdrop-filter: blur(3px);
}
.win-overlay.show { opacity: 1; pointer-events: all; }
.win-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 24px; padding: 32px 40px;
  text-align: center; backdrop-filter: blur(28px); -webkit-backdrop-filter: blur(28px);
  box-shadow: 0 20px 70px rgba(0,0,0,0.18);
  transform: scale(0.86) translateY(24px);
  transition: transform 0.5s cubic-bezier(0.34,1.56,0.64,1);
  max-width: 300px; width: 82vw;
}
.win-overlay.show .win-card { transform: scale(1) translateY(0); }
.win-emoji { font-size: 2.4rem; margin-bottom: 10px; }
.win-title { font-size: 1.15rem; font-weight: 600; letter-spacing: -0.3px; margin-bottom: 5px; }
.win-sub { font-size: 0.68rem; color: var(--muted); margin-bottom: 24px; }
.win-btns { display: flex; gap: 9px; justify-content: center; }
.win-btn {
  background: var(--btn); color: var(--btn-fg); border: none;
  border-radius: 50px; padding: 11px 20px;
  font-family: 'Outfit', sans-serif; font-size: 0.7rem; font-weight: 500;
  letter-spacing: 1px; text-transform: uppercase; cursor: pointer;
  transition: all 0.18s, background var(--tr), color var(--tr);
}
.win-btn:hover { transform: translateY(-1px); box-shadow: 0 5px 18px rgba(0,0,0,0.18); }
.win-btn.sec {
  background: none; border: 1px solid var(--border); color: var(--muted);
}
.win-btn.sec:hover { color: var(--text); border-color: var(--text); }

/* ‚ïê‚ïê CONFETTI ‚ïê‚ïê */
#confetti-canvas {
  position: fixed; inset: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 99; opacity: 0; transition: opacity 0.4s;
}
#confetti-canvas.show { opacity: 1; }

/* ‚ïê‚ïê KEYFRAMES ‚ïê‚ïê */
@keyframes selectedPulse {
  0%,100% { transform: scale(1); }
  50%      { transform: scale(1.05); }
}
@keyframes winLift {
  0%,100% { transform: translateY(0) scale(1); filter: brightness(1.1); }
  50%      { transform: translateY(-8px) scale(1.06); filter: brightness(1.22); }
}
@keyframes winGlow {
  0%,100% { filter: drop-shadow(0 0 22px var(--glow-win)) drop-shadow(0 0 9px var(--glow-win)); transform: scale(1); }
  50%      { filter: drop-shadow(0 0 40px var(--glow-win)) drop-shadow(0 0 18px var(--glow-win)); transform: scale(1.05); }
}
@keyframes winGlowOpp {
  0%,100% { filter: drop-shadow(0 0 22px var(--glow-lose)) drop-shadow(0 0 9px var(--glow-lose)); }
  50%      { filter: drop-shadow(0 0 40px var(--glow-lose)) drop-shadow(0 0 18px var(--glow-lose)); }
}
@keyframes introPulse {
  0%   { transform: scale(1); }
  42%  { transform: scale(1.18); }
  100% { transform: scale(1); }
}
@keyframes oppIn {
  from { opacity: 0; transform: translateX(28px) scale(0.78); }
  to   { opacity: 1; transform: translateX(0) scale(1); }
}
@keyframes scoreBump {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.4); }
  100% { transform: scale(1); }
}
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(5px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Entrance stagger */
.hdr        { animation: fadeUp 0.4s 0s    ease both; }
.score-wrap { animation: fadeUp 0.4s 0.05s ease both; }
.bf5        { animation: fadeUp 0.4s 0.09s ease both; }
.mode       { animation: fadeUp 0.4s 0.12s ease both; }
.stage-wrap { animation: fadeUp 0.4s 0.16s ease both; }
.result-area{ animation: fadeUp 0.4s 0.2s  ease both; }
.play-row   { animation: fadeUp 0.4s 0.24s ease both; }
.history    { animation: fadeUp 0.4s 0.27s ease both; }

/* ‚îÄ‚îÄ CHALLENGE BUTTON ‚îÄ‚îÄ */
.chal-btn {
  margin-top: 6px;
  background: none;
  border: 1px solid var(--border);
  border-radius: 50px;
  padding: 10px 0;
  width: 100%; max-width: 260px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.63rem; font-weight: 400;
  color: var(--muted); cursor: pointer;
  letter-spacing: 1.5px; text-transform: uppercase;
  transition: all 0.2s, border-color var(--tr), color var(--tr);
  display: flex; align-items: center; justify-content: center; gap: 7px;
}
.chal-btn:hover { color: var(--text); border-color: var(--text); }
.chal-btn svg { width: 13px; height: 13px; flex-shrink: 0; }

/* ‚îÄ‚îÄ ONLINE BADGE in header ‚îÄ‚îÄ */
.online-badge {
  display: none; align-items: center; gap: 5px;
  font-size: 0.5rem; letter-spacing: 1.5px;
  text-transform: uppercase; color: var(--win);
}
.online-badge.show { display: flex; }
.ob-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--win);
  animation: obPulse 1.4s ease-in-out infinite;
}
@keyframes obPulse {
  0%,100% { opacity:1; transform:scale(1); }
  50%      { opacity:0.35; transform:scale(0.75); }
}

/* ‚îÄ‚îÄ CHALLENGE OVERLAY ‚îÄ‚îÄ */
.ch-ov {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  z-index: 120; opacity: 0; pointer-events: none;
  transition: opacity 0.3s;
  background: rgba(0,0,0,0.22);
  backdrop-filter: blur(4px);
  padding: 20px;
}
.ch-ov.show { opacity: 1; pointer-events: all; }
.ch-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 22px; padding: 26px 22px;
  width: 100%; max-width: 340px;
  backdrop-filter: blur(28px); -webkit-backdrop-filter: blur(28px);
  box-shadow: 0 20px 60px rgba(0,0,0,0.18);
  transform: scale(0.9) translateY(14px);
  transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
  position: relative;
}
.ch-ov.show .ch-card { transform: scale(1) translateY(0); }
.ch-x {
  position: absolute; top: 13px; right: 15px;
  background: none; border: none; cursor: pointer;
  color: var(--muted); font-size: 1rem; line-height: 1;
  padding: 4px; transition: color 0.2s; font-family: 'Outfit', sans-serif;
}
.ch-x:hover { color: var(--text); }
.ch-card-title { font-size: 0.88rem; font-weight: 600; margin-bottom: 3px; }
.ch-card-sub {
  font-size: 0.63rem; color: var(--muted);
  line-height: 1.5; margin-bottom: 18px;
}
/* Tabs */
.ch-tabs {
  display: flex; background: var(--bg);
  border-radius: 50px; padding: 3px;
  margin-bottom: 18px; border: 1px solid var(--border);
}
.ch-tab {
  flex: 1; background: none; border: none;
  padding: 7px 0; border-radius: 50px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.63rem; color: var(--muted);
  cursor: pointer; transition: all 0.2s; letter-spacing: 0.3px;
}
.ch-tab.active { background: var(--btn); color: var(--btn-fg); }
/* Panels */
.ch-panel { display: none; flex-direction: column; align-items: center; gap: 13px; }
.ch-panel.show { display: flex; }
/* Code box */
.ch-code-box {
  width: 100%; background: var(--bg);
  border: 1px solid var(--border); border-radius: 14px;
  padding: 16px; text-align: center;
}
.ch-code-lbl {
  font-size: 0.5rem; letter-spacing: 2px;
  text-transform: uppercase; color: var(--muted); margin-bottom: 8px;
}
.ch-code-val {
  font-size: 2rem; font-weight: 700; letter-spacing: 7px;
  font-variant-numeric: tabular-nums; transition: opacity 0.3s;
  min-height: 2.5rem; display: flex; align-items: center; justify-content: center;
}
.ch-code-val.dim { opacity: 0.25; font-size: 1rem; letter-spacing: 2px; font-weight: 400; }
/* Status row */
.ch-status {
  font-size: 0.62rem; color: var(--muted);
  display: flex; align-items: center; gap: 6px; letter-spacing: 0.2px;
}
.ch-sdot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--muted);
  animation: obPulse 1.4s ease-in-out infinite;
  flex-shrink: 0;
}
.ch-sdot.ok  { background: var(--win); animation: none; }
.ch-sdot.err { background: var(--lose); animation: none; }
/* Buttons inside modal */
.ch-main-btn {
  width: 100%; background: var(--btn); color: var(--btn-fg); border: none;
  border-radius: 50px; padding: 12px 0;
  font-family: 'Outfit', sans-serif; font-size: 0.7rem; font-weight: 500;
  letter-spacing: 1.5px; text-transform: uppercase; cursor: pointer;
  transition: all 0.18s, background var(--tr);
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.ch-main-btn:hover { transform: translateY(-1px); box-shadow: 0 5px 18px rgba(0,0,0,0.14); }
.ch-main-btn:disabled { opacity: 0.28; transform: none; box-shadow: none; cursor: not-allowed; }
.ch-main-btn svg { width: 14px; height: 14px; }
/* Success banner */
.ch-success {
  display: none; width: 100%;
  background: rgba(26,122,66,0.09);
  border: 1px solid rgba(26,122,66,0.2);
  border-radius: 10px; padding: 11px 14px;
  font-size: 0.67rem; color: var(--win);
  align-items: center; justify-content: center; gap: 7px; text-align: center;
}
.ch-success.show { display: flex; }
/* Code input for join */
.ch-input {
  width: 100%; background: var(--bg);
  border: 1px solid var(--border); border-radius: 12px;
  padding: 14px 16px; font-family: 'Outfit', sans-serif;
  font-size: 1.5rem; font-weight: 700; letter-spacing: 7px;
  color: var(--text); text-transform: uppercase; text-align: center;
  outline: none; transition: border-color 0.2s; caret-color: var(--text);
}
.ch-input::placeholder { opacity: 0.18; font-size: 1rem; letter-spacing: 3px; font-weight: 400; }
.ch-input:focus { border-color: var(--text); }
</style>
<!-- PeerJS for multiplayer -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
</head>
<body>

<!-- HEADER -->
<div class="hdr">
  <span class="hdr-title">RPS</span>
  <div class="hdr-right">
    <div class="online-badge" id="ob"><div class="ob-dot"></div><span>Online</span></div>
    <button class="speaker-btn" id="spk" onclick="toggleMute()" aria-label="Toggle music">
      <svg id="ico-on" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
      </svg>
      <svg id="ico-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="display:none">
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
        <line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>
      </svg>
    </button>
    <button class="toggle" onclick="toggleTheme()" aria-label="Theme"></button>
  </div>
</div>

<!-- SCORE -->
<div class="score-wrap">
  <div class="score-pill"><span class="sl">You</span><span class="sn" id="s1">0</span></div>
  <span class="sdot">¬∑</span>
  <div class="score-pill"><span class="sn" id="s2">0</span><span class="sl" id="p2lbl">CPU</span></div>
</div>

<!-- BF5 -->
<div class="bf5" id="bf5">
  <div class="bf5-dot" id="d0"></div><div class="bf5-dot" id="d1"></div>
  <div class="bf5-dot" id="d2"></div><div class="bf5-dot" id="d3"></div>
  <div class="bf5-dot" id="d4"></div>
</div>

<!-- MODE -->
<div class="mode">
  <button class="active" onclick="setMode('cpu')">vs CPU</button>
  <button onclick="setMode('p2')">2 Players</button>
</div>

<!-- STAGE WRAPPER ‚Äî takes all remaining vertical space -->
<div class="stage-wrap">
  <div class="stage" id="stage">
    <!-- Three objects: rock, paper, scissors -->
    <div class="obj idle" id="o-rock" onclick="pick('rock')">
      <img id="i-rock" src="" alt="Rock" loading="eager" fetchpriority="high" onerror="fallbackImage(this,'rock')">
      <div class="obj-lbl">Rock</div>
    </div>
    <div class="obj idle" id="o-paper" onclick="pick('paper')">
      <img id="i-paper" src="" alt="Paper" loading="eager" fetchpriority="high" onerror="fallbackImage(this,'paper')">
      <div class="obj-lbl">Paper</div>
    </div>
    <div class="obj idle" id="o-scissors" onclick="pick('scissors')">
      <img id="i-scissors" src="" alt="Scissors" loading="eager" fetchpriority="high" onerror="fallbackImage(this,'scissors')">
      <div class="obj-lbl">Scissors</div>
    </div>

    <!-- Countdown (inside stage, centered) -->
    <div class="countdown" id="countdown">
      <div class="cd-dots">
        <div class="cd-dot" id="cd0"></div>
        <div class="cd-dot" id="cd1"></div>
        <div class="cd-dot" id="cd2"></div>
      </div>
      <div class="cd-shoot" id="cd-shoot">Shoot</div>
    </div>
  </div>
</div>

<!-- RESULT -->
<div class="result-area">
  <div class="rpill" id="rpill"></div>
  <div class="rsub" id="rsub" style="display:none"></div>
</div>

<!-- P2 -->
<div class="p2-row" id="p2row">
  <div class="p2-lbl">Player 2</div>
  <div class="p2-btns">
    <button class="p2-btn" id="p2r" onclick="pickP2('rock')">Rock</button>
    <button class="p2-btn" id="p2p" onclick="pickP2('paper')">Paper</button>
    <button class="p2-btn" id="p2s" onclick="pickP2('scissors')">Scissors</button>
  </div>
</div>

<!-- PLAY -->
<div class="play-row">
  <button class="pbtn" id="pbtn" onclick="startRound()" disabled>Play</button>
</div>

<!-- CHALLENGE BUTTON ROW -->
<div class="play-row" style="margin-top:5px">
  <button class="chal-btn" id="chal-btn" onclick="openCh()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.81 19.79 19.79 0 01.4 1.12 2 2 0 012 1h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.09 8.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16z"/>
    </svg>
    Challenge a Friend
  </button>
</div>

<!-- CHALLENGE OVERLAY -->
<div class="ch-ov" id="ch-ov">
  <div class="ch-card">
    <button class="ch-x" onclick="closeCh()">‚úï</button>
    <div class="ch-card-title">Play Online</div>
    <div class="ch-card-sub">Challenge a friend on their device in real time via WebRTC.</div>

    <div class="ch-tabs">
      <button class="ch-tab active" id="ch-t0" onclick="chTab(0)">Host Game</button>
      <button class="ch-tab"        id="ch-t1" onclick="chTab(1)">Accept Challenge</button>
    </div>

    <!-- HOST PANEL -->
    <div class="ch-panel show" id="ch-p0">
      <div class="ch-code-box">
        <div class="ch-code-lbl">Your Game Code</div>
        <div class="ch-code-val dim" id="ch-code">¬∑¬∑¬∑</div>
      </div>
      <div class="ch-status">
        <div class="ch-sdot" id="ch-sdot0"></div>
        <span id="ch-stxt0">Starting‚Ä¶</span>
      </div>
      <button class="ch-main-btn" id="ch-share" onclick="doShare()" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.81 19.79 19.79 0 01.4 1.12 2 2 0 012 1h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.09 8.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16z"/>
        </svg>
        Send Challenge via Text
      </button>
      <div class="ch-success" id="ch-ok0">‚úì Friend connected ‚Äî close and play!</div>
    </div>

    <!-- ACCEPT / JOIN PANEL -->
    <div class="ch-panel" id="ch-p1">
      <input class="ch-input" id="ch-inp" type="text" maxlength="6"
        placeholder="ABC123" autocomplete="off" autocorrect="off" spellcheck="false"
        oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')">
      <div class="ch-status" id="ch-jstat" style="display:none">
        <div class="ch-sdot" id="ch-sdot1"></div>
        <span id="ch-stxt1"></span>
      </div>
      <button class="ch-main-btn" id="ch-join-btn" onclick="doJoin()">Accept Challenge</button>
      <div class="ch-success" id="ch-ok1">‚úì Connected ‚Äî close and play!</div>
    </div>
  </div>
</div>


<!-- HISTORY -->
<div class="history">
  <div class="hlbl">Recent</div>
  <div class="hlist-scroll">
    <div class="hlist" id="hlist"></div>
  </div>
</div>

<!-- WIN OVERLAY -->
<div class="win-overlay" id="win-ov">
  <div class="win-card">
    <div class="win-emoji" id="win-emoji">üèÜ</div>
    <div class="win-title" id="win-title">You Won!</div>
    <div class="win-sub" id="win-sub">Best of 5</div>
    <div class="win-btns">
      <button class="win-btn" onclick="rematch()">Rematch</button>
      <button class="win-btn sec" onclick="rematch()">Next Opponent</button>
    </div>
  </div>
</div>

<canvas id="confetti-canvas"></canvas>

<!-- BGM audio element (external MP3) -->
<audio id="bgm" loop preload="auto" style="display:none" src="Chrono_Echoes_rockpaperscissors.mp3"></audio>

<!-- All game logic moved to bottom for faster visual rendering -->
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FALLBACK SVG GENERATOR (ultra‚Äëlight, minimalistic)
//  Called when a PNG fails to load
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fallbackImage(imgEl, move) {
  const theme = document.documentElement.getAttribute('data-theme') || 'light';
  const fill = theme === 'dark' ? '%23f0eeeb' : '%23111'; // hex without #
  let svg = '';
  if (move === 'rock') {
    svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 120"><circle cx="50" cy="60" r="42" fill="${fill}" stroke="${fill}" stroke-width="2"/></svg>`;
  } else if (move === 'paper') {
    svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 120"><rect x="20" y="20" width="60" height="80" rx="8" fill="${fill}" stroke="${fill}" stroke-width="2"/><polygon points="70,20 90,20 70,40" fill="${fill}"/></svg>`;
  } else { // scissors
    svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 120"><path d="M30 40 L70 80 M70 40 L30 80" stroke="${fill}" stroke-width="12" stroke-linecap="round"/><circle cx="25" cy="35" r="12" fill="${fill}"/><circle cx="75" cy="85" r="12" fill="${fill}"/></svg>`;
  }
  imgEl.src = 'data:image/svg+xml,' + encodeURIComponent(svg);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BGM ‚Äî controlled ONLY by speaker button (external MP3)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const bgm = document.getElementById('bgm');
bgm.volume = 0.18;
bgm.loop = true;

let bgmPlaying = false;
let bgmMuted = false;

function toggleMute() {
  if (!bgmPlaying) {
    bgm.play().then(() => {
      bgmPlaying = true;
      bgmMuted = false;
      updateSpeakerIcon(true);
    }).catch(e => console.warn('BGM play failed:', e));
  } else {
    bgmMuted = !bgmMuted;
    bgm.muted = bgmMuted;
    updateSpeakerIcon(!bgmMuted);
  }
}

function updateSpeakerIcon(playing) {
  document.getElementById('ico-on').style.display  = playing ? '' : 'none';
  document.getElementById('ico-off').style.display = playing ? 'none' : '';
}
updateSpeakerIcon(false);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SFX ‚Äî Web Audio (unchanged)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _AC = null;
function getAC() {
  if (!_AC) {
    try { _AC = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
  }
  if (_AC && _AC.state === 'suspended') _AC.resume().catch(() => {});
  return _AC;
}

function tone(freq, type='sine', dur=0.11, vol=0.15, delay=0) {
  const AC = getAC();
  if (!AC) return;
  try {
    const o = AC.createOscillator(), g = AC.createGain();
    o.connect(g); g.connect(AC.destination);
    o.type = type; o.frequency.value = freq;
    const t = AC.currentTime + delay;
    g.gain.setValueAtTime(0, t);
    g.gain.linearRampToValueAtTime(vol, t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, t + dur);
    o.start(t); o.stop(t + dur + 0.02);
  } catch(e) {}
}

const sfx = {
  select:    () => { tone(480,'sine',0.08,0.12); tone(720,'sine',0.07,0.07,0.06); },
  countdown: () => tone(200,'triangle',0.09,0.10),
  shoot:     () => { tone(340,'sine',0.05,0.09); tone(560,'sine',0.11,0.13,0.04); tone(900,'sine',0.09,0.11,0.09); },
  win:       () => { [523,659,784,1047].forEach((f,i) => tone(f,'sine',0.14,0.13,i*0.08)); },
  lose:      () => { [440,370,294].forEach((f,i) => tone(f,'triangle',0.16,0.11,i*0.09)); },
  tie:       () => { tone(392,'sine',0.12,0.09); tone(392,'sine',0.11,0.08,0.12); },
  intro:     (i) => tone([260,330,415][i],'sine',0.10,0.10),
  bigWin:    () => { [523,659,784,1047,1319,1047,1319].forEach((f,i) => tone(f,'sine',0.17,0.14,i*0.07)); },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const C = ['rock','paper','scissors'];
let theme='light', mode='cpu';
let p1c=null, p2c=null;
let sc=[0,0], bf5=[0,0];
let hist=[], busy=false, gameOver=false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THEME (external PNGs)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyTheme(t) {
  theme = t;
  document.documentElement.setAttribute('data-theme', t);
  // Build PNG filenames: e.g. 'white-rock-rps.png' or 'black-paper-rps.png'
  C.forEach(c => {
    const img = document.getElementById('i-'+c);
    img.src = (theme==='light' ? 'white' : 'black') + '-' + c + '-rps.png';
  });
}
function toggleTheme() { applyTheme(theme==='light'?'dark':'light'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODE (unchanged)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMode(m) {
  mode = m;
  document.querySelectorAll('.mode button').forEach((b,i) =>
    b.classList.toggle('active', (i===0&&m==='cpu')||(i===1&&m==='p2'))
  );
  document.getElementById('p2row').classList.toggle('on', m==='p2');
  document.getElementById('p2lbl').textContent = m==='p2' ? 'P2' : 'CPU';
  softReset();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PICK (idle phase) ‚Äì original logic, will be overridden for online
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pick = function(c) {
  if (busy || gameOver) return;
  p1c = c;
  sfx.select();
  C.forEach(x => {
    const el = document.getElementById('o-'+x);
    el.classList.remove('idle','selected','dimmed','no-anim');
    if (x===c) {
      el.classList.add('selected','no-anim');
    } else {
      el.classList.add('dimmed');
    }
  });
  updatePlayBtn();
};

function pickP2(c) {
  if (busy||gameOver) return;
  p2c = c;
  C.forEach(x => document.getElementById('p2'+x[0]).classList.toggle('on', x===c));
  updatePlayBtn();
}

function updatePlayBtn() {
  const ok = mode==='cpu' ? !!p1c : (!!p1c&&!!p2c);
  document.getElementById('pbtn').disabled = !ok||busy||gameOver;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INTRO PULSE, COUNTDOWN, ROUND (unchanged)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pulseOne(name, idx) {
  return new Promise(res => {
    const img = document.getElementById('i-'+name);
    sfx.intro(idx);
    img.style.animation = 'none';
    void img.offsetWidth;
    img.style.animation = 'introPulse 0.58s cubic-bezier(0.34,1.4,0.64,1) both';
    setTimeout(() => { img.style.animation=''; res(); }, 520);
  });
}

async function runIntro() {
  C.forEach(c => {
    const el = document.getElementById('o-'+c);
    el.classList.remove('selected','dimmed','no-anim','idle');
    document.getElementById('i-'+c).style.animation = 'none';
  });
  await pulseOne('rock',0);
  await pulseOne('paper',1);
  await pulseOne('scissors',2);
  C.forEach(c => {
    const el = document.getElementById('o-'+c);
    if (c===p1c) el.classList.add('selected','no-anim');
    else         el.classList.add('dimmed');
  });
}

function runCountdown() {
  return new Promise(res => {
    const cd = document.getElementById('countdown');
    const dots = [0,1,2].map(i => document.getElementById('cd'+i));
    const shoot = document.getElementById('cd-shoot');
    dots.forEach(d => { d.classList.remove('active'); });
    shoot.classList.remove('show');
    cd.classList.add('show');
    let i=0;
    function tick() {
      if (i<dots.length) {
        if(i>0) dots[i-1].classList.remove('active');
        dots[i].classList.add('active');
        sfx.countdown();
        i++; setTimeout(tick, 650);
      } else {
        dots.forEach(d=>d.classList.remove('active'));
        shoot.classList.add('show');
        sfx.shoot();
        setTimeout(() => {
          cd.classList.remove('show');
          shoot.classList.remove('show');
          res();
        }, 560);
      }
    }
    setTimeout(tick, 150);
  });
}

async function startRound() {
  if (busy||gameOver||!p1c) return;
  busy = true;
  document.getElementById('pbtn').disabled = true;
  document.querySelectorAll('.p2-btn').forEach(b=>b.disabled=true);

  await runIntro();
  await runCountdown();
  resolveRound();
}

function getResult(a,b) {
  if(a===b) return 'tie';
  return ((a==='rock'&&b==='scissors')||(a==='paper'&&b==='rock')||(a==='scissors'&&b==='paper')) ? 'win' : 'lose';
}

function resolveRound() {
  const opp = mode==='cpu' ? C[Math.floor(Math.random()*3)] : p2c;
  const res = getResult(p1c, opp);
  showBattle(p1c, opp, res);
}

function showBattle(myC, oppC, res) {
  const stage = document.getElementById('stage');

  C.forEach(c => {
    const el = document.getElementById('o-'+c);
    el.classList.remove('idle','selected','dimmed','winner','loser','no-anim','player-obj','opp-obj');
    el.style.cssText = '';
    document.getElementById('i-'+c).style.cssText = '';
  });
  const prevOpp = document.getElementById('o-opp');
  if (prevOpp) prevOpp.remove();

  stage.classList.add('battle');

  const myEl = document.getElementById('o-'+myC);
  myEl.classList.add('player-obj','no-anim');
  myEl.style.display = 'flex';

  C.forEach(c => {
    if (c!==myC) {
      const el = document.getElementById('o-'+c);
      el.style.display = 'none';
    }
  });

  const oppEl = document.createElement('div');
  oppEl.className = 'obj opp-obj no-anim';
  oppEl.id = 'o-opp';

  const oppImg = document.createElement('img');
  oppImg.id = 'i-opp';
  oppImg.src = (theme==='light' ? 'white' : 'black') + '-' + oppC + '-rps.png';
  oppImg.alt = oppC;
  oppImg.onerror = function() { fallbackImage(this, oppC); };
  const H = {rock:'clamp(140px,32vw,190px)', paper:'clamp(110px,25vw,155px)', scissors:'clamp(148px,34vw,198px)'};
  const W = {rock:'100px', paper:'115px', scissors:'72px'};
  Object.assign(oppImg.style, {
    display:'block', width:'auto', objectFit:'contain',
    objectPosition:'bottom center', height:H[oppC], maxWidth:W[oppC],
    pointerEvents:'none',
  });

  const lbl = document.createElement('div');
  lbl.className = 'obj-lbl';
  lbl.textContent = oppC[0].toUpperCase()+oppC.slice(1);

  oppEl.appendChild(oppImg);
  oppEl.appendChild(lbl);
  stage.appendChild(oppEl);

  requestAnimationFrame(() => {
    oppEl.style.animation = 'oppIn 0.42s cubic-bezier(0.34,1.4,0.64,1) both';
    setTimeout(() => { oppEl.style.animation=''; }, 480);
  });

  setTimeout(() => {
    if (res==='win') {
      myEl.classList.add('winner');
      oppEl.classList.add('loser');
      sfx.win();
    } else if (res==='lose') {
      myEl.classList.add('loser');
      oppEl.classList.add('winner');
      sfx.lose();
    } else {
      myEl.classList.add('winner');
      oppEl.classList.add('winner');
      sfx.tie();
    }

    if (res==='win')  { sc[0]++; bf5[0]++; bump('s1'); }
    if (res==='lose') { sc[1]++; bf5[1]++; bump('s2'); }
    document.getElementById('s1').textContent = sc[0];
    document.getElementById('s2').textContent = sc[1];
    updateBf5Dots();

    const N={rock:'Rock',paper:'Paper',scissors:'Scissors'};
    const oName=mode==='cpu'?'CPU':'P2';
    const labels={win:'You win',lose:mode==='cpu'?'CPU wins':'P2 wins',tie:'Draw'};
    const pill=document.getElementById('rpill');
    pill.textContent=labels[res]; pill.className='rpill show '+res;
    const sub=document.getElementById('rsub');
    sub.textContent=`You ¬∑ ${N[myC]}   ${oName} ¬∑ ${N[oppC]}`;
    sub.className='rsub show';

    hist.unshift({a:myC,b:oppC,res});
    if(hist.length>5) hist.pop();
    renderHist();

    const w5 = bf5[0]>=3?'p1': bf5[1]>=3?'p2': null;
    setTimeout(() => {
      if(w5) showWinOverlay(w5);
      else    resetRound();
    }, 2200);
  }, 360);
}

function bump(id) {
  const el=document.getElementById(id);
  el.classList.remove('bump'); void el.offsetWidth; el.classList.add('bump');
}

function updateBf5Dots() {
  for(let i=0;i<5;i++) {
    const d=document.getElementById('d'+i);
    d.className='bf5-dot';
    if(i<bf5[0]) d.classList.add('p1');
    else if(i>=5-bf5[1]) d.classList.add('p2');
  }
}

function showWinOverlay(winner) {
  gameOver=true;
  const isP1=winner==='p1';
  document.getElementById('win-emoji').textContent = isP1?'üèÜ':'üéØ';
  document.getElementById('win-title').textContent = isP1
    ? (mode==='cpu'?'You Won!':'Player 1 Wins!')
    : (mode==='cpu'?'CPU Wins!':'Player 2 Wins!');
  document.getElementById('win-sub').textContent = `Best of 5  ¬∑  ${bf5[0]} ‚Äì ${bf5[1]}`;
  document.getElementById('win-ov').classList.add('show');
  if(isP1) { sfx.bigWin(); startConfetti(); }
  else sfx.lose();
}

let rematch = function() {
  document.getElementById('win-ov').classList.remove('show');
  stopConfetti();
  sc=[0,0]; bf5=[0,0]; gameOver=false;
  document.getElementById('s1').textContent='0';
  document.getElementById('s2').textContent='0';
  hist=[]; renderHist(); updateBf5Dots();
  resetAll();
};

let cRAF=null, cP=[];
function startConfetti() {
  const cv=document.getElementById('confetti-canvas');
  cv.classList.add('show');
  const ctx=cv.getContext('2d');
  cv.width=window.innerWidth; cv.height=window.innerHeight;
  const cols=theme==='dark'?['#fff','#e0e0e0','#aaa','#888','#555']:['#111','#333','#666','#999','#ccc'];
  cP=Array.from({length:80},()=>({
    x:Math.random()*cv.width, y:-20-Math.random()*160,
    w:3+Math.random()*6, h:6+Math.random()*10,
    c:cols[Math.floor(Math.random()*cols.length)],
    vx:(Math.random()-.5)*2, vy:1.5+Math.random()*2.6,
    rot:Math.random()*360, vr:(Math.random()-.5)*3.5,
    op:0.65+Math.random()*0.35,
  }));
  function frame() {
    ctx.clearRect(0,0,cv.width,cv.height);
    cP.forEach(p=>{
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
      ctx.globalAlpha=p.op; ctx.fillStyle=p.c;
      ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();
      p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.vy+=0.035;
      if(p.y>cv.height+20){p.y=-20;p.x=Math.random()*cv.width;p.vy=1.5+Math.random()*2.6;}
    });
    cRAF=requestAnimationFrame(frame);
  }
  frame(); setTimeout(stopConfetti,5500);
}
function stopConfetti() {
  if(cRAF){cancelAnimationFrame(cRAF);cRAF=null;}
  const cv=document.getElementById('confetti-canvas');
  cv.classList.remove('show');
  cv.getContext('2d').clearRect(0,0,cv.width,cv.height);
}

function resetRound() {
  p1c=null; p2c=null; busy=false;

  const opp=document.getElementById('o-opp');
  if(opp) opp.remove();

  const stage=document.getElementById('stage');
  stage.classList.remove('battle');

  C.forEach(c => {
    const el=document.getElementById('o-'+c);
    el.style.cssText='';
    el.classList.remove('selected','dimmed','winner','loser','no-anim','player-obj','opp-obj');
    el.classList.add('idle');
    const img=document.getElementById('i-'+c);
    img.style.cssText='';
  });

  document.getElementById('rpill').className='rpill';
  document.getElementById('rsub').className='rsub';
  C.forEach(x=>document.getElementById('p2'+x[0]).classList.remove('on'));
  document.querySelectorAll('.p2-btn').forEach(b=>b.disabled=false);
  updatePlayBtn();
}

function softReset() { resetRound(); }
function resetAll() { softReset(); gameOver=false; updatePlayBtn(); }

function renderHist() {
  const N={rock:'Rock',paper:'Paper',scissors:'Scissors'};
  const R={win:'Win',lose:'Loss',tie:'Draw'};
  document.getElementById('hlist').innerHTML=hist.map(h=>
    `<div class="hitem"><div class="hmoves"><span>${N[h.a]}</span><div class="hdot"></div><span>${N[h.b]}</span></div><div class="hres ${h.res}">${R[h.res]}</div></div>`
  ).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ONLINE MULTIPLAYER (unchanged, except we removed base64)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let mpActive   = false;
let mpIsHost   = false;
let mpPeer     = null;
let mpConn     = null;
let mpMyCode   = '';
let mpMyChoice = null;
let mpOppChoice= null;
let mpBusy     = false;

function mpRoomId(code) { return 'rpsshoot-v1-' + code.toUpperCase(); }
function mpGuestId()    { return 'rpsshoot-guest-' + Math.random().toString(36).slice(2,9); }
function mpMakeCode() {
  const ch = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:6}, () => ch[Math.random()*ch.length|0]).join('');
}

function openCh()  {
  document.getElementById('ch-ov').classList.add('show');
  document.querySelector('.ch-tabs').style.display = 'none';
  chTab(0);
  if (!mpPeer || mpPeer.destroyed) initHost();
}
function closeCh() { document.getElementById('ch-ov').classList.remove('show'); }

function chTab(idx) {
  [0,1].forEach(i => {
    document.getElementById('ch-t'+i).classList.toggle('active', i===idx);
    document.getElementById('ch-p'+i).classList.toggle('show',   i===idx);
  });
  if (idx===0 && (!mpPeer || mpPeer.destroyed)) initHost();
}

function chHostStat(txt, state) {
  document.getElementById('ch-stxt0').textContent = txt;
  const d = document.getElementById('ch-sdot0');
  d.className = 'ch-sdot' + (state==='ok'?' ok': state==='err'?' err':'');
}
function chJoinStat(txt, state) {
  const row = document.getElementById('ch-jstat');
  row.style.display = txt ? '' : 'none';
  document.getElementById('ch-stxt1').textContent = txt;
  const d = document.getElementById('ch-sdot1');
  d.className = 'ch-sdot' + (state==='ok'?' ok': state==='err'?' err':'');
}

function initHost() {
  chHostStat('Generating code‚Ä¶', '');
  document.getElementById('ch-code').textContent = '¬∑¬∑¬∑';
  document.getElementById('ch-code').classList.add('dim');
  document.getElementById('ch-share').disabled = true;
  document.getElementById('ch-ok0').classList.remove('show');

  mpMyCode = mpMakeCode();
  if (mpPeer && !mpPeer.destroyed) { try { mpPeer.destroy(); } catch(e){} }

  try { mpPeer = new Peer(mpRoomId(mpMyCode)); } catch(e) {
    chHostStat('PeerJS unavailable', 'err'); return;
  }

  mpPeer.on('open', () => {
    document.getElementById('ch-code').textContent = mpMyCode;
    document.getElementById('ch-code').classList.remove('dim');
    document.getElementById('ch-share').disabled = false;
    chHostStat('Waiting for friend‚Ä¶', '');
    mpIsHost = true;
  });

  mpPeer.on('connection', c => {
    mpConn = c;
    mpWireConn();
    chHostStat('Friend connected!', 'ok');
    document.getElementById('ch-ok0').classList.add('show');
    document.getElementById('ch-share').disabled = true;
    mpGoLive();
    setTimeout(closeCh, 1400);
  });

  mpPeer.on('error', err => {
    const m = String(err.message||err);
    if (m.includes('unavailable') || m.includes('taken')) { setTimeout(initHost, 600); }
    else { chHostStat('Error ‚Äî try again', 'err'); }
  });
}

function doJoin() {
  const code = document.getElementById('ch-inp').value.trim().toUpperCase();
  if (code.length < 4) return;
  const btn = document.getElementById('ch-join-btn');
  btn.disabled = true;
  chJoinStat('Connecting‚Ä¶', '');
  document.getElementById('ch-jstat').style.display='';
  document.getElementById('ch-ok1').classList.remove('show');

  if (mpPeer && !mpPeer.destroyed) { try { mpPeer.destroy(); } catch(e){} }
  try { mpPeer = new Peer(mpGuestId()); } catch(e) {
    chJoinStat('PeerJS unavailable', 'err'); btn.disabled=false; return;
  }

  let joined = false;
  const timeout = setTimeout(() => {
    if (!joined) { chJoinStat('No response ‚Äî check code', 'err'); btn.disabled=false; }
  }, 9000);

  mpPeer.on('open', () => {
    mpConn = mpPeer.connect(mpRoomId(code), { reliable: true });
    mpConn.on('open', () => {
      joined = true; clearTimeout(timeout);
      mpWireConn();
      chJoinStat('Connected!', 'ok');
      document.getElementById('ch-ok1').classList.add('show');
      btn.disabled = false;
      mpIsHost = false;
      mpGoLive();
      setTimeout(closeCh, 1400);
    });
    mpConn.on('error', () => {
      clearTimeout(timeout);
      chJoinStat('Could not connect ‚Äî check code', 'err');
      btn.disabled = false;
    });
  });
  mpPeer.on('error', () => {
    clearTimeout(timeout);
    chJoinStat('Connection failed', 'err');
    btn.disabled = false;
  });
}

function mpWireConn() {
  mpConn.on('data', mpOnData);
  mpConn.on('close', mpOnDisconnect);
  mpConn.on('error', mpOnDisconnect);
}

function mpOnDisconnect() {
  if (!mpActive) return;
  mpActive = false;
  document.getElementById('ob').classList.remove('show');
  document.getElementById('p2lbl').textContent = 'CPU';
  const pill = document.getElementById('rpill');
  pill.textContent = 'Friend disconnected';
  pill.className = 'rpill show tie';
  softReset();
}

function mpOnData(data) {
  if (data.type === 'choice') {
    mpOppChoice = data.choice;
    if (mpMyChoice) mpResolve();
  }
  if (data.type === 'rematch') {
    sc=[0,0]; bf5=[0,0]; gameOver=false;
    document.getElementById('s1').textContent='0';
    document.getElementById('s2').textContent='0';
    hist=[]; renderHist(); updateBf5Dots();
    softReset();
  }
}

function mpGoLive() {
  mpActive = true;
  mpMyChoice = null; mpOppChoice = null; mpBusy = false;
  document.getElementById('ob').classList.add('show');
  document.getElementById('p2lbl').textContent = 'Friend';
  sc=[0,0]; bf5=[0,0]; gameOver=false;
  document.getElementById('s1').textContent='0';
  document.getElementById('s2').textContent='0';
  hist=[]; renderHist(); updateBf5Dots();
  softReset();
}

function mpSend(data) {
  if (mpConn && mpConn.open) { try { mpConn.send(data); } catch(e){} }
}

// Override pick for online
const _pick = pick;
pick = function(c) {
  if (!mpActive) { _pick(c); return; }
  if (mpBusy || gameOver) return;

  p1c = c;
  sfx.select();
  C.forEach(x => {
    const el = document.getElementById('o-'+x);
    el.classList.remove('idle','selected','dimmed','no-anim');
    if (x===c) el.classList.add('selected','no-anim');
    else        el.classList.add('dimmed');
  });

  mpMyChoice = c;
  mpSend({ type:'choice', choice:c });

  if (mpOppChoice) {
    mpResolve();
  } else {
    const pill = document.getElementById('rpill');
    pill.textContent = 'Waiting for friend‚Ä¶';
    pill.className = 'rpill show tie';
  }
};

function mpResolve() {
  const myC  = mpMyChoice;
  const oppC = mpOppChoice;
  mpMyChoice = null; mpOppChoice = null; mpBusy = true;
  document.getElementById('rpill').className = 'rpill';

  runIntro().then(() => runCountdown()).then(() => {
    showBattle(myC, oppC, getResult(myC, oppC));
    mpBusy = false;
  });
}

const _rematch = rematch;
rematch = function() {
  if (mpActive) mpSend({ type:'rematch' });
  _rematch();
};

function doShare() {
  const code = mpMyCode;
  const url  = location.href.split('?')[0];
  const link = url + '?join=' + code;
  const body = `I challenge you to Rock ¬∑ Paper ¬∑ Scissors! ü§ú\n\nJoin my game:\n${link}\n\nOr enter code: ${code}`;
  if (navigator.share) {
    navigator.share({ text: body }).catch(() => mpFallbackShare(body));
  } else {
    mpFallbackShare(body);
  }
}
function mpFallbackShare(body) {
  window.location.href = 'sms:?body=' + encodeURIComponent(body);
}

// Auto‚Äëjoin from URL
(function() {
  const p = new URLSearchParams(location.search);
  const j = p.get('join');
  if (j) {
    setTimeout(() => {
      document.getElementById('ch-ov').classList.add('show');
      document.querySelector('.ch-tabs').style.display = 'none';
      document.querySelector('.ch-card-title').textContent = 'Accept Challenge';
      document.querySelector('.ch-card-sub').textContent = 'Your friend is waiting. Enter the code to join.';
      chTab(1);
      const inp = document.getElementById('ch-inp');
      if (inp) inp.value = j.toUpperCase().slice(0,6);
    }, 900);
  }
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT (apply theme and set initial PNGs)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
applyTheme(window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light');
updatePlayBtn();
</script>
</body>
</html>
