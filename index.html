<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Rock · Paper · Scissors</title>
  
  <!-- Preload the correct theme PNGs -->
  <script>
    (function() {
      try {
        const isLight = document.documentElement.getAttribute('data-theme') === 'light';
        const images = isLight 
          ? ['white-rock-rps.PNG', 'white-paper-rps.PNG', 'white-scissors-rps.PNG']
          : ['black-rock-rps.PNG', 'black-paper-rps.PNG', 'black-scissors-rps.PNG'];
        
        images.forEach(img => {
          const link = document.createElement('link');
          link.rel = 'preload'; link.as = 'image'; link.href = img;  // remove /images/ if files are in root
          document.head.appendChild(link);
        });
      } catch(e) {}
    })();
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f0eeeb; --text: #111; --muted: rgba(0,0,0,0.28); --border: rgba(0,0,0,0.08);
      --surface: rgba(255,255,255,0.7); --btn: #111; --btn-fg: #f0eeeb;
      --win: #1a7a42; --lose: #b52038; --tie: #666; --tr: 0.34s cubic-bezier(0.4,0,0.2,1);
    }
    [data-theme=dark] {
      --bg: #0c0c0c; --text: #f0eeeb; --muted: rgba(240,238,235,0.28); --border: rgba(240,238,235,0.08);
      --surface: rgba(24,24,24,0.88); --btn: #f0eeeb; --btn-fg: #0c0c0c;
      --win: #50c87c; --lose: #e0506a; --tie: #aaa;
    }
    html, body { height: 100%; font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; max-width: 430px; margin: 0 auto; overflow: hidden; position: relative; transition: background var(--tr), color var(--tr); }
    
    /* Header & Network Indicator */
    .hdr { width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 16px 20px 0; flex-shrink: 0; }
    .hdr-title { font-size: 0.56rem; letter-spacing: 4px; text-transform: uppercase; color: var(--muted); }
    .hdr-right { display: flex; align-items: center; gap: 12px; }
    
    .net-status { display: flex; align-items: center; gap: 6px; font-size: 0.55rem; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); }
    .net-dot { width: 8px; height: 8px; border-radius: 50%; background: #50c87c; transition: background 0.3s; }
    .net-dot.offline { background: #e0506a; }
    
    .speaker-btn { width: 30px; height: 30px; background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--muted); transition: color 0.2s; outline: none; padding: 0; }
    .speaker-btn:hover { color: var(--text); }
    .speaker-btn svg { width: 17px; height: 17px; }
    
    .toggle { width: 36px; height: 20px; background: var(--border); border: 1px solid var(--border); border-radius: 20px; cursor: pointer; position: relative; transition: all var(--tr); outline: none; }
    .toggle::after { content: ''; position: absolute; width: 13px; height: 13px; background: var(--text); border-radius: 50%; top: 50%; left: 3px; transform: translateY(-50%); transition: left var(--tr), background var(--tr); }
    [data-theme=dark] .toggle::after { left: calc(100% - 16px); }

    /* Score */
    .score-wrap { display: flex; align-items: center; gap: 8px; margin-top: 12px; flex-shrink: 0; }
    .score-pill { background: var(--surface); border: 1px solid var(--border); border-radius: 50px; padding: 6px 16px; display: flex; align-items: center; gap: 7px; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    .sl { font-size: 0.55rem; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); }
    .sn { font-size: 1rem; font-weight: 600; min-width: 13px; text-align: center; }
    .sdot { color: var(--muted); font-size: 0.7rem; }

    /* Stage & Objects */
    .stage-wrap { flex: 1; width: 100%; position: relative; display: flex; align-items: center; justify-content: center; }
    .stage { width: 100%; height: 100%; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 12px; }
    .obj { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; cursor: pointer; transition: opacity 0.4s ease, transform 0.4s; -webkit-tap-highlight-color: transparent; }
    
    /* Image Consistency & Compression Handling */
    .obj img { width: auto; height: auto; max-width: 100%; object-fit: contain; display: block; pointer-events: none; animation: float 4s ease-in-out infinite; }
    
    #o-rock img { height: clamp(140px,32vw,190px); max-width: 100px; animation-delay: 0s; }
    #o-paper img { height: clamp(110px,25vw,155px); max-width: 115px; animation-delay: 1.1s; }
    #o-scissors img { height: clamp(148px,34vw,198px); max-width: 72px; animation-delay: 2.2s; }
    .obj-lbl { font-size: 0.5rem; letter-spacing: 2.5px; text-transform: uppercase; color: var(--muted); margin-top: 6px; }
    
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .obj.selected { transform: translateY(-12px) scale(1.04); }
    .obj.selected img { filter: brightness(1.18); }
    .obj.dimmed { opacity: 0; transform: scale(0.7) translateY(20px); pointer-events: none; }

    /* Play & Challenge Buttons */
    .play-row { padding: 10px 20px 0; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; flex-shrink: 0; }
    .pbtn { background: var(--btn); color: var(--btn-fg); border: none; border-radius: 50px; padding: 13px 0; width: 100%; max-width: 260px; font-family: 'Outfit'; font-size: 0.76rem; font-weight: 500; letter-spacing: 2.5px; text-transform: uppercase; cursor: pointer; transition: transform 0.2s; }
    .pbtn:active { transform: scale(0.96); }
    .pbtn:disabled { opacity: 0.2; pointer-events: none; }
    
    .cbtn { background: none; border: 1px solid var(--border); color: var(--muted); border-radius: 50px; padding: 8px 16px; font-family: 'Outfit'; font-size: 0.6rem; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
    .cbtn:hover { color: var(--text); border-color: var(--text); }
    .cbtn.offline { opacity: 0.35; pointer-events: none; }
    .cbtn-status { display: flex; align-items: center; justify-content: center; gap: 8px; }
    .spinner { width: 14px; height: 14px; border: 2px solid var(--muted); border-top-color: var(--text); border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* History & Modals */
    .history { width: 100%; padding: 10px 20px 0; display: flex; flex-direction: column; flex-shrink: 0; min-height: 0; }
    .hlbl { font-size: 0.48rem; letter-spacing: 3px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
    .hlist { display: flex; flex-direction: column; gap: 4px; }
    .hitem { background: var(--surface); border: 1px solid var(--border); border-radius: 9px; padding: 7px 12px; display: flex; justify-content: space-between; font-size: 0.64rem; color: var(--muted); animation: fadeUp 0.2s ease; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .hres.win{color:var(--win);} .hres.lose{color:var(--lose);} .hres.tie{color:var(--tie);}
    
    /* Result Overlay */
    .win-overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.4s; background: rgba(0,0,0,0.2); backdrop-filter: blur(3px); }
    .win-overlay.show { opacity: 1; pointer-events: all; }
    .win-card { background: var(--surface); border: 1px solid var(--border); border-radius: 24px; padding: 32px 40px; text-align: center; box-shadow: 0 20px 70px rgba(0,0,0,0.18); max-width: 300px; width: 82vw; transform: translateY(20px); transition: transform 0.4s; }
    .win-overlay.show .win-card { transform: translateY(0); }
    .win-icon { margin-bottom: 12px; color: var(--text); }
    .win-title { font-size: 1.15rem; font-weight: 600; margin-bottom: 24px; }
  </style>
</head>
<body>

<div class="hdr">
  <span class="hdr-title">RPS</span>
  <div class="hdr-right">
    <div class="net-status">
      <div class="net-dot" id="net-dot"></div>
      <span id="net-lbl">Online</span>
    </div>
    
    <button class="speaker-btn" onclick="toggleMute()">
      <svg id="ico-on" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
      <svg id="ico-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="display:none"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>
    </button>
    <button class="toggle" onclick="toggleTheme()"></button>
  </div>
</div>

<div class="score-wrap">
  <div class="score-pill"><span class="sl">You</span><span class="sn" id="s1">0</span></div>
  <span class="sdot">·</span>
  <div class="score-pill"><span class="sn" id="s2">0</span><span class="sl" id="p2lbl">CPU</span></div>
</div>

<div class="stage-wrap">
  <div class="stage" id="stage">
    <div class="obj idle" id="o-rock" onclick="pick('rock')">
      <img id="i-rock" src="" alt="Rock" decoding="async" loading="eager">
      <div class="obj-lbl">Rock</div>
    </div>
    <div class="obj idle" id="o-paper" onclick="pick('paper')">
      <img id="i-paper" src="" alt="Paper" decoding="async" loading="eager">
      <div class="obj-lbl">Paper</div>
    </div>
    <div class="obj idle" id="o-scissors" onclick="pick('scissors')">
      <img id="i-scissors" src="" alt="Scissors" decoding="async" loading="eager">
      <div class="obj-lbl">Scissors</div>
    </div>
  </div>
</div>

<div class="play-row">
  <button class="pbtn" id="pbtn" onclick="startRound()" disabled>Play</button>
  
  <button class="cbtn" id="chal-btn" onclick="initChallenge()">
    <div class="cbtn-status">
      <div class="spinner" id="c-spinner"></div>
      <svg id="c-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
        <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.81 19.79 19.79 0 01.4 1.12 2 2 0 012 1h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.09 8.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16z"/>
      </svg>
      <span id="c-text">Challenge a Friend</span>
    </div>
  </button>
</div>

<div class="history">
  <div class="hlbl">Recent</div>
  <div class="hlist" id="hlist"></div>
</div>

<div class="win-overlay" id="win-ov">
  <div class="win-card">
    <div class="win-icon" id="win-icon"></div>
    <div class="win-title" id="win-title">Result</div>
    <button class="pbtn" style="width: 80%; padding: 10px 0;" onclick="rematch()">Next Round</button>
  </div>
</div>

<audio id="bgm" loop preload="auto" src=""></audio>

<script>
// ══════════════════════════════════════
//  SERVICE WORKER REGISTRATION (optional)
// ══════════════════════════════════════
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW Registration Failed:', err));
  });
}

// ══════════════════════════════════════
//  ASSETS & THEME-AWARE SVG FALLBACKS
// ══════════════════════════════════════
const ASSETS = {
  rock: { dark: 'black-rock-rps.PNG', light: 'white-rock-rps.PNG' },
  paper: { dark: 'black-paper-rps.PNG', light: 'white-paper-rps.PNG' },
  scissors: { dark: 'black-scissors-rps.PNG', light: 'white-scissors-rps.PNG' }
};

// Returns an SVG that matches the current theme color (black or white)
function getOfflineSvg(type, theme) {
  const color = theme === 'dark' ? '%23f0eeeb' : '%23111'; // #f0eeeb or #111
  if (type === 'rock') return `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="${color}"/></svg>`;
  if (type === 'paper') return `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" fill="${color}"/></svg>`;
  if (type === 'scissors') return `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 4l16 16M4 20L20 4" stroke="${color}" stroke-width="4" stroke-linecap="round"/></svg>`;
}

const WIN_SVGS = {
  win: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="48" height="48"><path d="M8 21h8M12 17v4M7 4h10M5 4v5a2 2 0 002 2h10a2 2 0 002-2V4M3 4h18M5 9c-2 0-3-1-3-3s1-3 3-3h14c2 0 3 1 3 3s-1 3-3 3"/></svg>`,
  lose: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="48" height="48"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`
};

function loadImages(theme) {
  const applyImage = (id, type, pngSrc) => {
    const img = document.getElementById(id);
    img.onerror = () => { img.src = getOfflineSvg(type, theme); }; 
    img.src = pngSrc;
  };
  applyImage('i-rock', 'rock', ASSETS.rock[theme]);
  applyImage('i-paper', 'paper', ASSETS.paper[theme]);
  applyImage('i-scissors', 'scissors', ASSETS.scissors[theme]);
}

// ══════════════════════════════════════
//  GAME STATE & NETWORK LOGIC
// ══════════════════════════════════════
let myScore = 0, oppScore = 0;
let myMove = null, oppMove = null;
let peer = null, conn = null;
let challengeTimer = null;
let bgm = document.getElementById('bgm');

window.onload = () => {
  const isLight = document.documentElement.getAttribute('data-theme') === 'light';
  loadImages(isLight ? 'light' : 'dark');
  
  checkNetwork();
  window.addEventListener('online', checkNetwork);
  window.addEventListener('offline', checkNetwork);

  const urlParams = new URLSearchParams(window.location.search);
  const joinCode = urlParams.get('join');
  
  peer = new Peer(Math.random().toString(36).substring(2, 8).toUpperCase());
  peer.on('open', id => {
    if (joinCode) connectToPeer(joinCode);
  });
  peer.on('connection', c => {
    conn = c;
    setupConnection();
  });
  peer.on('error', handleDisconnect);
};

function toggleTheme() {
  const root = document.documentElement;
  const isDark = root.getAttribute('data-theme') === 'dark';
  const newTheme = isDark ? 'light' : 'dark';
  root.setAttribute('data-theme', newTheme);
  loadImages(newTheme);
}

function toggleMute() {
  if (bgm.paused) { bgm.play(); document.getElementById('ico-on').style.display='none'; document.getElementById('ico-off').style.display='block'; }
  else { bgm.pause(); document.getElementById('ico-on').style.display='block'; document.getElementById('ico-off').style.display='none'; }
}

function checkNetwork() {
  const dot = document.getElementById('net-dot');
  const lbl = document.getElementById('net-lbl');
  const chalBtn = document.getElementById('chal-btn');
  
  if (navigator.onLine) {
    dot.classList.remove('offline');
    lbl.innerText = 'Online';
    chalBtn.classList.remove('offline');
  } else {
    dot.classList.add('offline');
    lbl.innerText = 'Offline';
    chalBtn.classList.add('offline');
    resetChallengeBtn();
  }
}

// ══════════════════════════════════════
//  CHALLENGE & DISCONNECT HANDLING
// ══════════════════════════════════════
function initChallenge() {
  if (!navigator.onLine) return;
  if (!peer || !peer.id) return alert("Connecting to server, please wait...");

  document.getElementById('c-spinner').style.display = 'block';
  document.getElementById('c-icon').style.display = 'none';
  document.getElementById('c-text').innerText = "Waiting for friend...";
  
  const link = `${window.location.origin}${window.location.pathname}?join=${peer.id}`;
  const msg = `Play Rock Paper Scissors with me! Tap here: ${link}`;

  // Native share sheet, with properly encoded SMS fallback
  if (navigator.share) {
    navigator.share({ text: msg }).catch(err => console.log("Share canceled", err));
  } else {
    window.location.href = `sms:?body=${encodeURIComponent(msg)}`;
  }

  // 30s timeout
  clearTimeout(challengeTimer);
  challengeTimer = setTimeout(() => {
    if (!conn || !conn.open) {
      resetChallengeBtn();
    }
  }, 30000); 
}

function resetChallengeBtn() {
  document.getElementById('chal-btn').style.display = 'flex';
  document.getElementById('c-spinner').style.display = 'none';
  document.getElementById('c-icon').style.display = 'block';
  document.getElementById('c-text').innerText = "Challenge a Friend";
}

function connectToPeer(id) {
  conn = peer.connect(id);
  setupConnection();
}

function setupConnection() {
  clearTimeout(challengeTimer);
  
  document.getElementById('chal-btn').style.display = 'none'; 
  document.getElementById('p2lbl').innerText = "P2"; 
  myScore = 0; oppScore = 0; 
  updateScoreUI();

  conn.on('data', data => {
    if (data.type === 'MOVE') {
      oppMove = data.choice;
      if (myMove) resolveRound();
    }
  });

  conn.on('close', handleDisconnect);
}

function handleDisconnect() {
  if (conn) { conn.close(); conn = null; }
  document.getElementById('p2lbl').innerText = "CPU";
  myScore = 0; oppScore = 0;
  updateScoreUI();
  resetChallengeBtn();
}

// ══════════════════════════════════════
//  CORE GAMEPLAY & UI
// ══════════════════════════════════════
function pick(choice) {
  myMove = choice;
  
  document.querySelectorAll('.obj').forEach(el => el.classList.remove('selected', 'dimmed'));
  const selectedObj = document.getElementById(`o-${choice}`);
  selectedObj.classList.add('selected');
  document.querySelectorAll('.obj').forEach(el => {
    if (el !== selectedObj) el.classList.add('dimmed');
  });

  document.getElementById('pbtn').disabled = false;
}

function startRound() {
  if (!myMove) return;
  document.getElementById('pbtn').disabled = true;

  if (conn && conn.open) {
    conn.send({ type: 'MOVE', choice: myMove });
    if (oppMove) {
      resolveRound();
    } else {
      document.getElementById('pbtn').innerText = "Waiting for P2...";
    }
  } else {
    const choices = ['rock', 'paper', 'scissors'];
    oppMove = choices[Math.floor(Math.random() * 3)];
    resolveRound();
  }
}

function resolveRound() {
  document.getElementById('pbtn').innerText = "Play";
  
  let result = 'tie';
  if ((myMove === 'rock' && oppMove === 'scissors') || 
      (myMove === 'paper' && oppMove === 'rock') || 
      (myMove === 'scissors' && oppMove === 'paper')) {
    result = 'win';
    myScore++;
  } else if (myMove !== oppMove) {
    result = 'lose';
    oppScore++;
  }
  
  updateScoreUI();
  updateHistory(result, myMove, oppMove);
  showResult(result);
  
  myMove = null; oppMove = null;
}

function updateScoreUI() {
  document.getElementById('s1').innerText = myScore;
  document.getElementById('s2').innerText = oppScore;
}

function updateHistory(res, m1, m2) {
  const hlist = document.getElementById('hlist');
  const div = document.createElement('div');
  div.className = 'hitem';
  const label = res === 'win' ? 'You Won' : (res === 'lose' ? 'P2 Won' : 'Tie');
  
  div.innerHTML = `
    <span class="hmoves">${m1} <span class="sdot">•</span> ${m2}</span>
    <span class="hres ${res}">${label}</span>
  `;
  hlist.prepend(div);
  
  if (hlist.children.length > 5) {
    hlist.removeChild(hlist.lastChild);
  }
}

function showResult(result) {
  const modal = document.getElementById('win-ov');
  const icon = document.getElementById('win-icon');
  const title = document.getElementById('win-title');
  const opponentName = (conn && conn.open) ? "P2" : "CPU";
  
  if (result === 'win') {
    icon.innerHTML = WIN_SVGS.win;
    title.innerText = "You Won!";
  } else if (result === 'lose') {
    icon.innerHTML = WIN_SVGS.lose;
    title.innerText = `${opponentName} Won`;
  } else {
    icon.innerHTML = "";
    title.innerText = "It's a Tie";
  }
  
  modal.classList.add('show');
}

function rematch() {
  document.getElementById('win-ov').classList.remove('show');
  document.querySelectorAll('.obj').forEach(el => el.classList.remove('selected', 'dimmed'));
}
</script>
</body>
</html>
