<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>rock · paper · scissors</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #f0eeeb;
      --text: #111;
      --muted: rgba(0, 0, 0, 0.28);
      --border: rgba(0, 0, 0, 0.08);
      --surface: rgba(255, 255, 255, 0.7);
      --btn: #111;
      --btn-fg: #f0eeeb;
      --win: #1a7a42;
      --lose: #b52038;
      --tie: #666;
      --tr: 0.34s cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme='dark'] {
      --bg: #0c0c0c;
      --text: #f0eeeb;
      --muted: rgba(240, 238, 235, 0.28);
      --border: rgba(240, 238, 235, 0.08);
      --surface: rgba(24, 24, 24, 0.88);
      --btn: #f0eeeb;
      --btn-fg: #0c0c0c;
      --win: #50c87c;
      --lose: #e0506a;
      --tie: #aaa;
    }

    html {
      height: 100%;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 430px;
      margin: 0 auto;
      overflow: hidden;
      position: relative;
      transition: background var(--tr), color var(--tr);
      padding-top: env(safe-area-inset-top, 0);
      padding-bottom: env(safe-area-inset-bottom, 0);
    }

    /* ══ HEADER ═══════════════════════ */
    .hdr {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px 0;
      flex-shrink: 0;
    }

    .hdr-title {
      font-size: 0.56rem;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 400;
    }

    .hdr-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .online-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.55rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .online-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #aaa;
      transition: background 0.2s;
    }

    .online-dot.online {
      background: #50c87c;
    }

    .speaker-btn {
      width: 30px;
      height: 30px;
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      transition: color 0.2s;
      outline: none;
      padding: 0;
      flex-shrink: 0;
    }

    .speaker-btn:hover {
      color: var(--text);
    }

    .speaker-btn svg {
      width: 17px;
      height: 17px;
    }

    .toggle {
      width: 36px;
      height: 20px;
      background: var(--border);
      border: 1px solid var(--border);
      border-radius: 20px;
      cursor: pointer;
      position: relative;
      transition: all var(--tr);
      outline: none;
      flex-shrink: 0;
    }

    .toggle::after {
      content: '';
      position: absolute;
      width: 13px;
      height: 13px;
      background: var(--text);
      border-radius: 50%;
      top: 50%;
      left: 3px;
      transform: translateY(-50%);
      transition: left var(--tr), background var(--tr);
    }

    [data-theme='dark'] .toggle::after {
      left: calc(100% - 16px);
    }

    /* ══ SCORE ════════════════════════ */
    .score-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      flex-shrink: 0;
    }

    .score-pill {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 50px;
      padding: 6px 16px;
      display: flex;
      align-items: center;
      gap: 7px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: background var(--tr), border var(--tr);
    }

    .sl {
      font-size: 0.55rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .sn {
      font-size: 1rem;
      font-weight: 600;
      min-width: 13px;
      text-align: center;
      transition: transform 0.2s;
    }

    .sdot {
      color: var(--muted);
      font-size: 0.7rem;
    }

    /* ══ STAGE – THE PLAYING AREA ══════ */
    .stage-wrap {
      flex: 1;
      width: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: visible;
    }

    .stage {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 12px;
      position: relative;
    }

    .obj {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      position: relative;
      flex: 1;
      transition: opacity 0.4s ease, transform 0.45s cubic-bezier(0.34, 1.4, 0.64, 1);
      will-change: transform, opacity;
    }

    .obj img,
    .obj svg {
      display: block;
      width: 100%;
      height: auto;
      max-height: 180px;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
      transition: filter 0.35s ease;
      color: var(--text);
      object-fit: contain;
    }

    /* different aspect ratios */
    #o-rock img,
    #o-rock svg {
      max-width: 100px;
    }

    #o-paper img,
    #o-paper svg {
      max-width: 115px;
    }

    #o-scissors img,
    #o-scissors svg {
      max-width: 72px;
    }

    .obj-lbl {
      font-size: 0.5rem;
      letter-spacing: 2.5px;
      text-transform: uppercase;
      color: var(--muted);
      margin-top: 6px;
      transition: color 0.3s;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* float animation */
    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .obj img,
    .obj svg {
      animation: float 4s ease-in-out infinite;
    }

    #o-rock img,
    #o-rock svg {
      animation-delay: 0s;
    }

    #o-paper img,
    #o-paper svg {
      animation-delay: 1.1s;
    }

    #o-scissors img,
    #o-scissors svg {
      animation-delay: 2.2s;
    }

    .obj.no-anim img,
    .obj.no-anim svg {
      animation: none;
    }

    .obj.idle:hover {
      transform: translateY(-9px);
    }

    .obj.idle:active {
      transform: scale(0.92);
      transition-duration: 0.08s;
    }

    .obj.selected {
      transform: translateY(-12px) scale(1.04);
      cursor: default;
    }

    .obj.selected img,
    .obj.selected svg {
      animation: selectedPulse 2s ease-in-out infinite;
      filter: none !important;
    }

    .obj.selected .obj-lbl {
      color: var(--text);
    }

    .obj.dimmed {
      opacity: 0;
      transform: scale(0.7) translateY(20px);
      pointer-events: none;
    }

    /* battle layout */
    .stage.battle {
      justify-content: space-between;
      padding: 0 16px 12px;
    }

    .stage.battle .obj.player-obj,
    .stage.battle .obj.opp-obj {
      flex: 1;
      align-items: center;
      cursor: default;
      transform: none !important;
    }

    .obj.winner img,
    .obj.winner svg {
      animation: winLift 1.8s ease-in-out infinite !important;
    }

    .obj.loser {
      opacity: 0.12;
    }

    .obj.loser img,
    .obj.loser svg {
      animation: none !important;
      filter: none !important;
    }

    @keyframes selectedPulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    @keyframes winLift {

      0%,
      100% {
        transform: translateY(0) scale(1);
        filter: brightness(1.1);
      }

      50% {
        transform: translateY(-8px) scale(1.06);
        filter: brightness(1.22);
      }
    }

    @keyframes oppIn {
      from {
        opacity: 0;
        transform: translateX(28px) scale(0.78);
      }

      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    /* ══ PLAY & CHALLENGE BUTTONS ═════ */
    .play-row {
      padding: 10px 20px 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .pbtn {
      background: var(--btn);
      color: var(--btn-fg);
      border: none;
      border-radius: 50px;
      padding: 13px 0;
      width: 100%;
      max-width: 260px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.76rem;
      font-weight: 500;
      letter-spacing: 2.5px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s, background var(--tr), color var(--tr);
      text-align: center;
    }

    .pbtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.18);
    }

    .pbtn:active {
      transform: scale(0.96);
    }

    .pbtn:disabled {
      opacity: 0.2;
      transform: none !important;
      box-shadow: none;
      cursor: not-allowed;
    }

    .cbtn {
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      border-radius: 50px;
      padding: 8px 16px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.6rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      max-width: 260px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cbtn:hover {
      color: var(--text);
      border-color: var(--text);
    }

    .cbtn-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid var(--muted);
      border-top-color: var(--text);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: none;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ══ HISTORY ══════════════════════ */
    .history {
      width: 100%;
      padding: 10px 20px 0;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      min-height: 0;
    }

    .hlbl {
      font-size: 0.48rem;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
      flex-shrink: 0;
    }

    .hlist-scroll {
      overflow-y: auto;
      max-height: 201px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .hlist-scroll::-webkit-scrollbar {
      display: none;
    }

    .hlist {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hitem {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 9px;
      padding: 7px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(6px);
      animation: fadeUp 0.2s ease both;
      transition: background var(--tr), border var(--tr);
      flex-shrink: 0;
      font-size: 0.64rem;
      color: var(--muted);
    }

    .hmoves {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .hres {
      font-size: 0.57rem;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .hres.win {
      color: var(--win);
    }

    .hres.lose {
      color: var(--lose);
    }

    .hres.tie {
      color: var(--tie);
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ══ WIN OVERLAY ══════════════════ */
    .win-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(3px);
    }

    .win-overlay.show {
      opacity: 1;
      pointer-events: all;
    }

    .win-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 32px 40px;
      text-align: center;
      backdrop-filter: blur(28px);
      -webkit-backdrop-filter: blur(28px);
      box-shadow: 0 20px 70px rgba(0, 0, 0, 0.18);
      transform: scale(0.86) translateY(24px);
      transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-width: 300px;
      width: 82vw;
    }

    .win-overlay.show .win-card {
      transform: scale(1) translateY(0);
    }

    .win-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .win-icon svg {
      width: 48px;
      height: 48px;
    }

    .win-title {
      font-size: 1.15rem;
      font-weight: 600;
      margin-bottom: 24px;
    }

    .win-btns {
      display: flex;
      gap: 9px;
      justify-content: center;
    }

    .win-btn {
      background: var(--btn);
      color: var(--btn-fg);
      border: none;
      border-radius: 50px;
      padding: 11px 20px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.18s, background var(--tr), color var(--tr);
    }

    .win-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 5px 18px rgba(0, 0, 0, 0.18);
    }

    .win-btn.sec {
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .win-btn.sec:hover {
      color: var(--text);
      border-color: var(--text);
    }

    /* entrance stagger */
    .hdr {
      animation: fadeUp 0.4s 0s ease both;
    }

    .score-wrap {
      animation: fadeUp 0.4s 0.05s ease both;
    }

    .stage-wrap {
      animation: fadeUp 0.4s 0.16s ease both;
    }

    .play-row {
      animation: fadeUp 0.4s 0.24s ease both;
    }

    .history {
      animation: fadeUp 0.4s 0.27s ease both;
    }
  </style>
  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>

<body>

  <!-- HEADER -->
  <div class="hdr">
    <span class="hdr-title">RPS</span>
    <div class="hdr-right">
      <div class="online-indicator">
        <div class="online-dot" id="online-dot"></div>
        <span id="online-text">online</span>
      </div>
      <button class="speaker-btn" onclick="toggleMute()" aria-label="Toggle music">
        <svg id="ico-on" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
          stroke-linecap="round" stroke-linejoin="round">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
          <path d="M15.54 8.46a5 5 0 0 1 0 7.07" />
          <path d="M19.07 4.93a10 10 0 0 1 0 14.14" />
        </svg>
        <svg id="ico-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
          stroke-linecap="round" stroke-linejoin="round" style="display:none">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
          <line x1="23" y1="9" x2="17" y2="15" />
          <line x1="17" y1="9" x2="23" y2="15" />
        </svg>
      </button>
      <button class="toggle" onclick="toggleTheme()" aria-label="Theme"></button>
    </div>
  </div>

  <!-- SCORE -->
  <div class="score-wrap">
    <div class="score-pill"><span class="sl">You</span><span class="sn" id="s1">0</span></div>
    <span class="sdot">·</span>
    <div class="score-pill"><span class="sn" id="s2">0</span><span class="sl" id="p2lbl">CPU</span></div>
  </div>

  <!-- STAGE – three objects -->
  <div class="stage-wrap">
    <div class="stage" id="stage">
      <!-- rock -->
      <div class="obj idle" id="o-rock" onclick="pick('rock')">
        <img id="i-rock" alt="Rock">
        <div class="obj-lbl">Rock</div>
      </div>
      <!-- paper -->
      <div class="obj idle" id="o-paper" onclick="pick('paper')">
        <img id="i-paper" alt="Paper">
        <div class="obj-lbl">Paper</div>
      </div>
      <!-- scissors -->
      <div class="obj idle" id="o-scissors" onclick="pick('scissors')">
        <img id="i-scissors" alt="Scissors">
        <div class="obj-lbl">Scissors</div>
      </div>
    </div>
  </div>

  <!-- PLAY & CHALLENGE BUTTONS -->
  <div class="play-row">
    <button class="pbtn" id="pbtn" onclick="startRound()" disabled>Play</button>

    <button class="cbtn" id="chal-btn" onclick="initChallenge()">
      <div class="cbtn-status">
        <div class="spinner" id="c-spinner"></div>
        <svg id="c-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
          stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
          <path
            d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.81 19.79 19.79 0 01.4 1.12 2 2 0 012 1h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.09 8.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16z" />
        </svg>
        <span id="c-text">Challenge a Friend</span>
      </div>
    </button>
  </div>

  <!-- HISTORY -->
  <div class="history">
    <div class="hlbl">Recent</div>
    <div class="hlist-scroll">
      <div class="hlist" id="hlist"></div>
    </div>
  </div>

  <!-- WIN OVERLAY -->
  <div class="win-overlay" id="win-ov">
    <div class="win-card">
      <div class="win-icon" id="win-icon"></div>
      <div class="win-title" id="win-title">Result</div>
      <button class="win-btn" onclick="rematch()">Next Round</button>
    </div>
  </div>

  <!-- audio (silent) -->
  <audio id="bgm" loop preload="auto" style="display:none"></audio>

  <script>
    // ════════════════════════════════════════════════════════════
    //  ASSETS – exact filenames (uppercase .PNG)
    // ════════════════════════════════════════════════════════════
    const IMG_PATHS = {
      light: {
        rock: 'white-rock-rps.PNG',
        paper: 'white-paper-rps.PNG',
        scissors: 'white-scissors-rps.PNG'
      },
      dark: {
        rock: 'black-rock-rps.PNG',
        paper: 'black-paper-rps.PNG',
        scissors: 'black-scissors-rps.PNG'
      }
    };

    // Offline fallbacks – perfect geometric shapes (theme‑aware)
    function createFallbackSVG(choice) {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('viewBox', '0 0 100 120');
      svg.setAttribute('fill', 'currentColor');

      if (choice === 'rock') {
        // circle
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', '50');
        circle.setAttribute('cy', '60');
        circle.setAttribute('r', '35');
        svg.appendChild(circle);
      } else if (choice === 'paper') {
        // square
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', '25');
        rect.setAttribute('y', '30');
        rect.setAttribute('width', '50');
        rect.setAttribute('height', '50');
        rect.setAttribute('rx', '6');
        svg.appendChild(rect);
      } else if (choice === 'scissors') {
        // X
        const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line1.setAttribute('x1', '30');
        line1.setAttribute('y1', '30');
        line1.setAttribute('x2', '70');
        line1.setAttribute('y2', '70');
        line1.setAttribute('stroke', 'currentColor');
        line1.setAttribute('stroke-width', '12');
        line1.setAttribute('stroke-linecap', 'round');
        svg.appendChild(line1);
        const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line2.setAttribute('x1', '70');
        line2.setAttribute('y1', '30');
        line2.setAttribute('x2', '30');
        line2.setAttribute('y2', '70');
        line2.setAttribute('stroke', 'currentColor');
        line2.setAttribute('stroke-width', '12');
        line2.setAttribute('stroke-linecap', 'round');
        svg.appendChild(line2);
      }
      return svg;
    }

    // ════════════════════════════════════════════════════════════
    //  GLOBAL STATE
    // ════════════════════════════════════════════════════════════
    const C = ['rock', 'paper', 'scissors'];
    let theme = 'light';
    let myScore = 0, oppScore = 0;
    let myMove = null, oppMove = null;
    let busy = false;
    let gameOver = false;
    let hist = [];

    // Multiplayer
    let peer = null;
    let conn = null;
    let challengeTimer = null;

    // Audio
    const bgm = document.getElementById('bgm');
    let bgmPlaying = false;

    // ════════════════════════════════════════════════════════════
    //  INIT
    // ════════════════════════════════════════════════════════════
    window.onload = () => {
      // Set initial theme (prefer dark)
      const prefersDark = window.matchMedia('(prefers-color-scheme:dark)').matches;
      theme = prefersDark ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', theme);
      loadImages();

      // Network indicator
      updateOnlineStatus();
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);

      // PeerJS setup
      peer = new Peer(); // let Peer generate an ID
      peer.on('open', id => {
        // ID stored, but we don't show it – we'll use ?join param later
        console.log('Peer ID:', id);
      });
      peer.on('connection', c => {
        conn = c;
        setupConnection();
      });

      // Auto‑join from URL (deep link)
      const urlParams = new URLSearchParams(window.location.search);
      const joinCode = urlParams.get('join');
      if (joinCode) {
        connectToPeer(joinCode);
      }
    };

    function loadImages() {
      const themeImages = theme === 'light' ? IMG_PATHS.light : IMG_PATHS.dark;
      C.forEach(choice => {
        const img = document.getElementById('i-' + choice);
        const container = img.parentNode;
        // remove any fallback SVG
        const oldSvg = container.querySelector('svg');
        if (oldSvg) oldSvg.remove();

        if (navigator.onLine) {
          // try to load PNG
          img.src = themeImages[choice];
          img.onerror = () => useFallback(choice, img);
          img.style.display = 'block';
        } else {
          useFallback(choice, img);
        }
      });
    }

    function useFallback(choice, imgElement) {
      imgElement.style.display = 'none';
      const container = imgElement.parentNode;
      const oldSvg = container.querySelector('svg');
      if (oldSvg) oldSvg.remove();
      container.appendChild(createFallbackSVG(choice));
    }

    function updateOnlineStatus() {
      const dot = document.getElementById('online-dot');
      const text = document.getElementById('online-text');
      if (navigator.onLine) {
        dot.classList.add('online');
        text.innerText = 'online';
      } else {
        dot.classList.remove('online');
        text.innerText = 'offline';
      }
      loadImages(); // refresh images (PNG or fallback)
    }

    function toggleTheme() {
      theme = theme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', theme);
      loadImages();
    }

    function toggleMute() {
      if (!bgmPlaying) {
        bgm.play().then(() => {
          bgmPlaying = true;
          document.getElementById('ico-on').style.display = 'none';
          document.getElementById('ico-off').style.display = 'block';
        }).catch(() => { });
      } else {
        bgm.pause();
        bgmPlaying = false;
        document.getElementById('ico-on').style.display = 'block';
        document.getElementById('ico-off').style.display = 'none';
      }
    }

    // ════════════════════════════════════════════════════════════
    //  CHALLENGE LOGIC (30s timeout)
    // ════════════════════════════════════════════════════════════
    function initChallenge() {
      if (!navigator.onLine) {
        alert("You are offline. Challenge is unavailable.");
        return;
      }
      // show spinner, hide icon
      document.getElementById('c-spinner').style.display = 'block';
      document.getElementById('c-icon').style.display = 'none';
      document.getElementById('c-text').innerText = "Waiting for friend...";

      // generate shareable link with peer ID
      const link = `${window.location.origin}${window.location.pathname}?join=${peer.id}`;
      // try SMS first, fallback to copy
      if (navigator.share) {
        navigator.share({
          text: `Play Rock Paper Scissors with me! Tap here: ${link}`
        }).catch(() => {
          window.location.href = `sms:?body=Play RPS with me! ${link}`;
        });
      } else {
        window.location.href = `sms:?body=Play RPS with me! ${link}`;
      }

      // 30 second timeout – you can keep playing CPU while waiting
      clearTimeout(challengeTimer);
      challengeTimer = setTimeout(() => {
        if (!conn || !conn.open) {
          resetChallengeBtn();
        }
      }, 30000);
    }

    function resetChallengeBtn() {
      document.getElementById('c-spinner').style.display = 'none';
      document.getElementById('c-icon').style.display = 'block';
      document.getElementById('c-text').innerText = "Challenge a Friend";
    }

    function connectToPeer(id) {
      conn = peer.connect(id);
      setupConnection();
    }

    function setupConnection() {
      clearTimeout(challengeTimer);
      // Hide challenge button, update score label
      document.getElementById('chal-btn').style.display = 'none';
      document.getElementById('p2lbl').innerText = "P2";
      // Reset scores for fairness
      myScore = 0; oppScore = 0;
      updateScoreUI();
      hist = [];
      renderHist();

      conn.on('data', data => {
        if (data.type === 'MOVE') {
          oppMove = data.choice;
          if (myMove && !busy) resolveRound();
        }
      });

      conn.on('close', () => {
        conn = null;
        document.getElementById('chal-btn').style.display = 'flex';
        document.getElementById('p2lbl').innerText = "CPU";
        resetChallengeBtn();
      });
    }

    function sendMove(choice) {
      if (conn && conn.open) {
        conn.send({ type: 'MOVE', choice: choice });
      }
    }

    // ════════════════════════════════════════════════════════════
    //  CORE GAMEPLAY
    // ════════════════════════════════════════════════════════════
    function pick(choice) {
      if (busy || gameOver) return;
      myMove = choice;

      // Visual feedback
      C.forEach(c => {
        const el = document.getElementById('o-' + c);
        el.classList.remove('selected', 'dimmed');
        if (c === choice) {
          el.classList.add('selected');
        } else {
          el.classList.add('dimmed');
        }
      });

      document.getElementById('pbtn').disabled = false;
    }

    function startRound() {
      if (!myMove || busy || gameOver) return;
      busy = true;
      document.getElementById('pbtn').disabled = true;

      if (conn && conn.open) {
        // online – send move, wait for opponent
        sendMove(myMove);
        if (oppMove) {
          // both moves already ready? unlikely, but just in case
          resolveRound();
        } else {
          document.getElementById('pbtn').innerText = "Waiting for P2...";
        }
      } else {
        // CPU mode – generate random move
        oppMove = C[Math.floor(Math.random() * 3)];
        resolveRound();
      }
    }

    function resolveRound() {
      // Determine result
      let result = 'tie';
      if ((myMove === 'rock' && oppMove === 'scissors') ||
        (myMove === 'paper' && oppMove === 'rock') ||
        (myMove === 'scissors' && oppMove === 'paper')) {
        result = 'win';
        myScore++;
      } else if (myMove !== oppMove) {
        result = 'lose';
        oppScore++;
      }

      updateScoreUI();
      addHistory(result, myMove, oppMove);
      showResult(result);

      // Clear moves for next round
      myMove = null;
      oppMove = null;
      busy = false;
      document.getElementById('pbtn').innerText = "Play";
    }

    function updateScoreUI() {
      document.getElementById('s1').innerText = myScore;
      document.getElementById('s2').innerText = oppScore;
    }

    function addHistory(res, a, b) {
      const hlist = document.getElementById('hlist');
      const div = document.createElement('div');
      div.className = 'hitem';
      const label = res === 'win' ? 'Win' : (res === 'lose' ? 'Loss' : 'Draw');
      const nameMap = { rock: 'Rock', paper: 'Paper', scissors: 'Scissors' };
      div.innerHTML = `
        <div class="hmoves">
          <span>${nameMap[a]}</span>
          <span class="hdot">·</span>
          <span>${nameMap[b]}</span>
        </div>
        <div class="hres ${res}">${label}</div>
      `;
      hlist.prepend(div);
      if (hlist.children.length > 5) {
        hlist.removeChild(hlist.lastChild);
      }
    }

    function renderHist() {
      // not needed – we manage directly in addHistory
    }

    function showResult(res) {
      const overlay = document.getElementById('win-ov');
      const icon = document.getElementById('win-icon');
      const title = document.getElementById('win-title');
      const oppName = conn ? 'P2' : 'CPU';

      if (res === 'win') {
        icon.innerHTML = `<svg viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="1.8">
          <path d="M24 6 L30 22 L46 22 L34 34 L38 46 L24 38 L10 46 L14 34 L2 22 L18 22 L24 6 Z" />
        </svg>`;
        title.innerText = "You Won!";
      } else if (res === 'lose') {
        icon.innerHTML = `<svg viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="2.5">
          <circle cx="24" cy="24" r="20" fill="none" stroke="currentColor" opacity="0.2" stroke-width="1.5"/>
          <circle cx="24" cy="24" r="14" fill="none" stroke="currentColor" stroke-width="2"/>
          <circle cx="24" cy="24" r="6" fill="currentColor" />
        </svg>`;
        title.innerText = oppName + " Won";
      } else {
        icon.innerHTML = "";
        title.innerText = "It's a Tie";
      }
      overlay.classList.add('show');
    }

    function rematch() {
      // hide overlay, reset board
      document.getElementById('win-ov').classList.remove('show');

      // Remove opponent if exists
      const oldOpp = document.getElementById('o-opp');
      if (oldOpp) oldOpp.remove();

      // Reset stage
      const stage = document.getElementById('stage');
      stage.classList.remove('battle');

      C.forEach(c => {
        const el = document.getElementById('o-' + c);
        el.style.display = ''; // restore
        el.classList.remove('selected', 'dimmed', 'winner', 'loser', 'no-anim', 'player-obj', 'opp-obj');
        el.classList.add('idle');
      });

      // Ensure images are correct
      loadImages();

      // Clear moves
      myMove = null;
      oppMove = null;
      busy = false;
      document.getElementById('pbtn').disabled = true;
      document.getElementById('pbtn').innerText = "Play";
    }
  </script>
</body>

</html>
