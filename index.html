<!-- Keep your existing HTML and image tags from v11 -->

<!-- Win / Lose icon container -->
<div id="resultIcon" class="result-icon"></div>

<!-- Existing buttons; DO NOT change their IDs or structure -->
<button id="rockBtn">Rock</button>
<button id="paperBtn">Paper</button>
<button id="scissorsBtn">Scissors</button>

<button id="twoPlayerBtn">2 Players</button>
<button id="cpuBtn">vs CPU</button>

<button id="challengeButton">Challenge a Friend</button>

<!-- PeerJS (unpkg, safer for Vercel) -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
  // --- Minimal v12 integration on top of v11 ---

  // 1) Win / Lose icon rendering with SVG (replacing emoji)
  const resultIconEl = document.getElementById('resultIcon');

  function renderResultIcon(result) {
    // result: 'win' | 'lose' | 'tie'
    if (!resultIconEl) return;

    const color = getComputedStyle(document.documentElement)
      .getPropertyValue('--text-color') || '#ffffff';

    if (result === 'win') {
      resultIconEl.innerHTML = `
        <svg width="32" height="32" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="9" fill="none" stroke="${color}" stroke-width="1.6" />
          <path d="M9 13.5l1.8 1.8L15 11" fill="none" stroke="${color}" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M8 17h8" fill="none" stroke="${color}" stroke-width="1.6" stroke-linecap="round" />
        </svg>
      `;
    } else if (result === 'lose') {
      resultIconEl.innerHTML = `
        <svg width="32" height="32" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="9" fill="none" stroke="${color}" stroke-width="1.6" />
          <circle cx="12" cy="12" r="4.8" fill="none" stroke="${color}" stroke-width="1.6" />
          <circle cx="12" cy="12" r="1.2" fill="${color}" />
        </svg>
      `;
    } else {
      resultIconEl.innerHTML = '';
    }
  }

  // 2) Lightweight confetti (editorial style)
  function launchConfetti() {
    const confettiContainer = document.createElement('div');
    confettiContainer.style.position = 'fixed';
    confettiContainer.style.left = '0';
    confettiContainer.style.top = '0';
    confettiContainer.style.width = '100%';
    confettiContainer.style.height = '100%';
    confettiContainer.style.pointerEvents = 'none';
    confettiContainer.style.overflow = 'hidden';
    confettiContainer.style.zIndex = '9999';
    document.body.appendChild(confettiContainer);

    const color = getComputedStyle(document.documentElement)
      .getPropertyValue('--text-color') || '#ffffff';
    const count = 28;

    for (let i = 0; i < count; i++) {
      const bar = document.createElement('div');
      bar.style.position = 'absolute';
      bar.style.width = '2px';
      bar.style.height = `${40 + Math.random() * 40}px`;
      bar.style.left = `${Math.random() * 100}%`;
      bar.style.top = `-80px`;
      bar.style.backgroundColor = color.trim() || '#ffffff';
      bar.style.opacity = '0.9';
      bar.style.transform = `translate3d(0, 0, 0)`;
      bar.style.transition = 'transform 3.8s ease-out, opacity 3.8s ease-out';
      confettiContainer.appendChild(bar);

      // trigger layout
      void bar.offsetHeight;

      const translateY = window.innerHeight + 120;
      const driftX = (Math.random() - 0.5) * 60;

      bar.style.transform = `translate3d(${driftX}px, ${translateY}px, 0)`;
      bar.style.opacity = '0';
    }

    setTimeout(() => {
      if (confettiContainer.parentNode) {
        confettiContainer.parentNode.removeChild(confettiContainer);
      }
    }, 4000);
  }

  // Example hook: call renderResultIcon + confetti from your existing game logic
  // Integrate this into your v11 "end round" logic:
  function onRoundFinished(result) {
    // result: 'win' | 'lose' | 'tie'
    renderResultIcon(result);
    if (result === 'win') {
      launchConfetti();
    }
  }

  // 3) Challenge-a-Friend (PeerJS auto-link flow)
  const challengeBtn = document.getElementById('challengeButton');
  const opponentLabel = document.getElementById('opponentLabel'); // optional if you have one
  let peer = null;
  let conn = null;
  let isHost = false;

  function isOnline() {
    return navigator.onLine;
  }

  function updateChallengeButtonState() {
    if (!challengeBtn) return;
    if (isOnline()) {
      challengeBtn.disabled = false;
      challengeBtn.style.opacity = '1';
    } else {
      challengeBtn.disabled = true;
      challengeBtn.style.opacity = '0.35';
    }
  }

  window.addEventListener('online', updateChallengeButtonState);
  window.addEventListener('offline', updateChallengeButtonState);
  updateChallengeButtonState();

  function initializePeerIfNeeded() {
    if (peer) return;

    peer = new Peer(undefined, {
      debug: 1
    });

    peer.on('open', (id) => {
      const url = new URL(window.location.href);
      const code = id;
      url.searchParams.set('code', code);
      if (isHost) {
        const shareUrl = url.toString();
        // Use native share if available, otherwise fallback to prompt
        if (navigator.share) {
          navigator.share({
            title: 'Rock Paper Scissors',
            text: 'Tap to play Rock Paper Scissors with me!',
            url: shareUrl
          }).catch(() => {});
        } else {
          window.prompt('Send this link to your friend:', shareUrl);
        }
      }
    });

    peer.on('connection', (c) => {
      conn = c;
      setupConnectionHandlers();
      onFriendConnected();
    });

    peer.on('error', (err) => {
      console.error(err);
      if (challengeBtn) {
        challengeBtn.textContent = 'Challenge a Friend';
      }
    });
  }

  function setupConnectionHandlers() {
    if (!conn) return;
    conn.on('data', (data) => {
      // Handle messages from friend here (moves, resets, etc.)
      // You can map this onto your v11 "2 Player" logic.
      handleIncomingMessage(data);
    });

    conn.on('close', () => {
      conn = null;
      onFriendDisconnected();
    });
  }

  function onFriendConnected() {
    if (opponentLabel) {
      opponentLabel.textContent = 'Friend';
    }
    // Reset scores, etc. Hook into your existing reset logic:
    resetGameForMultiplayer();
    if (challengeBtn) {
      challengeBtn.textContent = 'Connected';
    }
  }

  function onFriendDisconnected() {
    if (opponentLabel) {
      opponentLabel.textContent = 'CPU';
    }
    if (challengeBtn) {
      challengeBtn.textContent = 'Challenge a Friend';
    }
  }

  function handleIncomingMessage(data) {
    // { type: 'move', value: 'rock' } etc.
    // Integrate with your existing v11 move handling.
    // Example:
    if (data.type === 'move') {
      applyRemoteMove(data.value);
    } else if (data.type === 'reset') {
      resetGameForMultiplayer();
    }
  }

  function sendMessage(msg) {
    if (conn && conn.open) {
      conn.send(msg);
    }
  }

  // Hook these sendMessage calls into your existing v11 UI:
  // e.g. when local player picks a move in Friend mode, call:
  // sendMessage({ type: 'move', value: 'rock' });

  // Host flow
  if (challengeBtn) {
    challengeBtn.addEventListener('click', () => {
      if (!isOnline()) return;
      isHost = true;
      challengeBtn.disabled = true;
      challengeBtn.textContent = 'Send Challenge via Text…';
      initializePeerIfNeeded();
    });
  }

  // Receiver flow
  const url = new URL(window.location.href);
  const incomingCode = url.searchParams.get('code');
  if (incomingCode) {
    // Receiver: auto-connect
    isHost = false;
    initializePeerIfNeeded();
    const waitForPeer = setInterval(() => {
      if (peer && peer.open) {
        clearInterval(waitForPeer);
        if (challengeBtn) {
          challengeBtn.textContent = 'Connecting…';
          challengeBtn.disabled = true;
        }
        conn = peer.connect(incomingCode);
        setupConnectionHandlers();
        conn.on('open', () => {
          onFriendConnected();
        });
      }
    }, 100);
  }

  // 4) Stubs to connect to your existing v11 logic
  function resetGameForMultiplayer() {
    // Call your existing reset logic here.
    // Example:
    // resetScores();
    // resetUI();
  }

  function applyRemoteMove(move) {
    // Map friend move into your existing v11 "2 Players" logic.
    // Example: handleSecondPlayerMove(move);
  }
</script>
